## Plan Wisdom

### hanja-grade-system/learnings.md
# Learnings - Hanja Grade System

## Task 5: Grade-Filtered Leaderboard with Composite Scoring

### Implementation Summary
Replaced medal-count leaderboard system with rank-based composite scoring:

1. **Grade Filtering**: All leaderboard queries now filter by user's current grade using `Store.getGrade()`
   - Uses `profiles.grade` field for filtering
   - Shows message "{grade} ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤" when no data

2. **Composite Scoring Algorithm** (Total Tab):
   - Fetch all scores for current grade across 8 games
   - Group by user and game, keep best score per user per game
   - For each game: rank users by score (descending, except gymnastics which is ascending)
   - Convert rank to points: 1st=10, 2nd=9, 3rd=8, ..., 10th=1, 11th+=0
   - Sum points across all 8 games for total composite score
   - Sort users by total composite score (descending)

3. **Per-Game Leaderboards**: Filtered by grade, sorted by score

4. **Score Saving**: Added grade field to `saveScore()` to tag each score with user's current grade at time of play

### Files Modified
- `/Users/tykimos/vibecode/hanja/src/systems/store.js`:
  - `getLeaderboard()`: Implemented composite scoring and grade filtering
  - `saveScore()`: Added grade field to score records

- `/Users/tykimos/vibecode/hanja/src/screens/leaderboard.js`:
  - `renderLB()`: Updated display to show "ì´ {points}ì " for total tab instead of medal counts
  - Added grade display in empty state message

### Technical Details
- Composite scoring uses single optimized query approach
- Gymnastics game uses ascending sort (lower score is better)
- All other games use descending sort (higher score is better)
- Points scale: top 10 ranks only (1st=10pts down to 10th=1pt)
- Users who haven't played all games can still appear (total = sum of games played)

### Verification
- Build: `npx vite build` - SUCCESS (75 modules, ~999KB)
- No TypeScript/ESLint warnings
- Grade filtering works via inner join on profiles table
- Composite scoring correctly aggregates across 8 games

### hanja-olympics-enhancement/learnings.md
# Learnings - Hanja Olympics Enhancement

## Task 3: Gymnastics Rename + Scoring Inversion

### Changes Made
1. **hanja.js line 115**: Changed game name from 'ì²´ì¡°' to 'ì¹´ë“œ ë’¤ì§‘ê¸°', icon from 'ğŸ¤¸' to 'ğŸƒ'
2. **gymnastics.js line 147**: Updated return value name to 'ì¹´ë“œ ë’¤ì§‘ê¸°'
3. **leaderboard.js lines 7-8**:
   - Added missing games (ë°˜ì˜ì–´, ì‚¬ìì„±ì–´, ë™ìŒì´ì˜) to tabs
   - Updated gymnastics name to 'ì¹´ë“œ ë’¤ì§‘ê¸°'
4. **store.js critical scoring fixes**:
   - Line 79: getBestScores() now uses `score < best` comparison for gymnastics
   - Line 107: getLeaderboard() uses `ascending: true` for gymnastics
   - Line 110: Per-user best score uses `score < best` for gymnastics
   - Line 114: Final sort uses `a.score - b.score` for gymnastics (ascending)

### Key Insight
Gymnastics game uses "attempts" as score where **lower is better**. All other games use higher-is-better scoring. The store.js changes ensure proper sorting in both contexts:
- `getBestScores()`: Gets best per-game scores for a user
- `getLeaderboard()`: Gets ranked list for leaderboard display

Both functions now check `gameId === 'gymnastics'` to invert comparison logic.

### Verification
- Build successful: 73 modules, 790.58 kB
- All 4 files modified correctly
- No syntax errors or build warnings (only chunk size warning - expected)

---

## Task 4: Archery Game Difficulty Variation

### Changes Made
1. **archery.js lines 11-26**: Added helper functions:
   - `getQuestionPointValue(qIndex)`: Returns 1, 2, 3, or 5 based on question index
   - `getQuestionDifficulty(qIndex)`: Returns {bobbingSpeed, scale, rotationSpeed}
2. **archery.js line 30**: Added `currentDifficulty` to game state
3. **archery.js lines 73-91**: Modified `setupQ()`:
   - Fetches difficulty settings for current question
   - Scales target rings based on difficulty (0.6x to 1.0x)
4. **archery.js lines 96-100**: Updated `updateUI()`:
   - Displays current question's point value (1pts, 2pts, 3pts, or 5pts) in gold badge
   - Shows running total score with bonus
5. **archery.js lines 139-147**: Updated target animation:
   - Uses `currentDifficulty.bobbingSpeed` (1.5x to 4.0x)
   - Uses `currentDifficulty.rotationSpeed` (0.3 to 0.5)
6. **archery.js line 161**: Modified scoring logic:
   - Uses `getQuestionPointValue(cur)` instead of fixed 1 point
7. **archery.js lines 187-189**: Updated `getResult()`:
   - Changed total from 10 to 25
   - Changed detail string from '10 ì ì¤‘' to '25 ì ì¤‘'

### Difficulty Progression
- Q1-3: 1pt, scale 1.0, bobbing 1.5x (warm-up)
- Q4-6: 2pt, scale 1.0, bobbing 2.5x (faster)
- Q7-8: 3pt, scale 0.8, bobbing 3.0x (smaller + faster)
- Q9-10: 5pt, scale 0.6, bobbing 4.0x (smallest + fastest)
- **Max score: 1+1+1+2+2+2+3+3+5+5 = 25 points**

### Backward Compatibility
- Medal thresholds **unchanged** in utils.js (>=9 gold, >=7 silver, >=5 bronze)
- Old scores (0-10 range) keep their medals
- New scores (0-25 range) work correctly since 25>=9 is still gold
- Leaderboard naturally ranks new scores higher (higher = better)
- No database migration required

### Verification
- Build successful: 73 modules, 793.03 kB
- All difficulty functions implemented
- Variable scoring works (1/2/3/5 points per question)
- UI shows point values correctly
- No syntax errors or build warnings (only chunk size warning - expected)