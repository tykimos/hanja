<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>한자 올림픽</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
--blue:#0081C8;--yellow:#FCB131;--black:#000;--green:#00A651;--red:#EE334E;
--bg:#F5F5F0;--gold:#FFD700;--silver:#C0C0C0;--bronze:#CD7F32;
--card-bg:#fff;--shadow:0 2px 12px rgba(0,0,0,.1);
--radius:16px;--transition:0.3s ease;
}
html{font-size:16px;-webkit-tap-highlight-color:transparent;}
body{
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;
background:var(--bg);color:#333;min-height:100vh;min-height:100dvh;
overflow-x:hidden;
}
.app-container{
max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;
position:relative;overflow:hidden;
}
.screen{
display:none;flex-direction:column;align-items:center;
min-height:100vh;min-height:100dvh;padding:20px 16px;
width:100%;
}
.screen.active{display:flex;}

/* Buttons */
button{
font-family:inherit;font-size:1rem;border:none;cursor:pointer;
touch-action:manipulation;min-height:44px;min-width:44px;
border-radius:12px;padding:12px 24px;font-weight:600;
transition:transform .15s,box-shadow .15s,background .2s;
-webkit-user-select:none;user-select:none;
}
button:active{transform:scale(.96);}
.btn-primary{background:var(--blue);color:#fff;box-shadow:0 4px 12px rgba(0,129,200,.3);}
.btn-primary:hover{background:#006aa3;}
.btn-secondary{background:#e8e8e4;color:#333;}
.btn-gold{background:linear-gradient(135deg,#FFD700,#FFA500);color:#fff;box-shadow:0 4px 12px rgba(255,165,0,.3);}
.btn-red{background:var(--red);color:#fff;}
.btn-green{background:var(--green);color:#fff;}
.btn-outline{background:transparent;border:2px solid var(--blue);color:var(--blue);}

/* Typography */
.title-lg{font-size:1.8rem;font-weight:800;text-align:center;}
.title-md{font-size:1.4rem;font-weight:700;text-align:center;}
.title-sm{font-size:1.1rem;font-weight:600;}
.subtitle{font-size:.9rem;color:#777;text-align:center;}
.hanja-display{
font-size:clamp(48px,10vw,96px);font-weight:400;line-height:1.2;
font-family:'Noto Serif KR',serif;
}

/* Cards */
.card{
background:var(--card-bg);border-radius:var(--radius);
padding:20px;box-shadow:var(--shadow);width:100%;
}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounceIn{
0%{opacity:0;transform:scale(.3)}
50%{opacity:1;transform:scale(1.08)}
70%{transform:scale(.95)}
100%{transform:scale(1)}
}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
@keyframes medalDrop{
0%{opacity:0;transform:translateY(-120px) scale(.5)}
60%{opacity:1;transform:translateY(10px) scale(1.1)}
80%{transform:translateY(-5px) scale(.98)}
100%{transform:translateY(0) scale(1)}
}
@keyframes confettiFall{
0%{transform:translateY(-10px) rotate(0deg);opacity:1}
100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes ringPulse{0%,100%{box-shadow:0 0 0 0 rgba(0,129,200,.3)}50%{box-shadow:0 0 0 12px rgba(0,129,200,0)}}
.anim-fadeIn{animation:fadeIn .4s ease both;}
.anim-bounceIn{animation:bounceIn .5s ease both;}
.anim-shake{animation:shake .4s ease;}
.anim-slideUp{animation:slideUp .4s ease both;}

/* Splash */
#screen-splash{justify-content:center;gap:24px;background:linear-gradient(135deg,#f8f9fa,#e8edf2);}
.olympic-rings{display:flex;justify-content:center;gap:4px;margin-bottom:8px;}
.ring{
width:40px;height:40px;border-radius:50%;border:4px solid;
display:inline-block;
}
.ring:nth-child(1){border-color:var(--blue);}
.ring:nth-child(2){border-color:var(--yellow);margin-top:16px;}
.ring:nth-child(3){border-color:var(--black);}
.ring:nth-child(4){border-color:var(--green);margin-top:16px;}
.ring:nth-child(5){border-color:var(--red);}
.splash-title{font-size:2.4rem;font-weight:900;background:linear-gradient(135deg,var(--blue),var(--red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.splash-sub{font-size:1rem;color:#888;}

/* Auth */
#screen-auth{justify-content:center;gap:20px;}
.auth-tabs{display:flex;gap:0;width:100%;border-radius:12px;overflow:hidden;background:#e8e8e4;}
.auth-tab{
flex:1;padding:12px;text-align:center;font-weight:600;
background:transparent;border-radius:0;color:#888;
}
.auth-tab.active{background:var(--blue);color:#fff;}
.auth-form{width:100%;display:flex;flex-direction:column;gap:14px;}
.input-group{display:flex;flex-direction:column;gap:6px;}
.input-group label{font-size:.85rem;font-weight:600;color:#555;}
.input-group input{
padding:12px 16px;border:2px solid #ddd;border-radius:12px;
font-size:1rem;outline:none;transition:border .2s;
font-family:inherit;
}
.input-group input:focus{border-color:var(--blue);}
.icon-picker{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
.icon-option{
width:48px;height:48px;border-radius:50%;border:3px solid transparent;
display:flex;align-items:center;justify-content:center;font-size:1.5rem;
background:#f0f0f0;cursor:pointer;transition:border .2s,transform .2s;
}
.icon-option.selected{border-color:var(--blue);transform:scale(1.15);background:#e0f0ff;}
.auth-error{color:var(--red);font-size:.85rem;text-align:center;min-height:20px;}

/* Hub */
#screen-hub{gap:16px;padding-top:16px;}
.hub-header{
width:100%;display:flex;justify-content:space-between;align-items:center;
padding:0 4px;
}
.hub-user{display:flex;align-items:center;gap:8px;}
.hub-user-icon{font-size:1.6rem;}
.hub-user-name{font-weight:700;font-size:1.1rem;}
.hub-title{
text-align:center;font-size:1.5rem;font-weight:800;margin:4px 0;
}
.daily-card{
background:linear-gradient(135deg,#667eea,#764ba2);
color:#fff;border-radius:var(--radius);padding:20px;
width:100%;cursor:pointer;transition:transform .2s;
}
.daily-card:active{transform:scale(.98);}
.daily-card-title{font-size:1.2rem;font-weight:700;margin-bottom:4px;}
.daily-card-info{font-size:.85rem;opacity:.9;}
.daily-streak{
display:inline-flex;align-items:center;gap:4px;
background:rgba(255,255,255,.2);border-radius:20px;padding:4px 12px;
font-size:.85rem;margin-top:8px;
}
.game-grid{
display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;
}
.game-card{
background:var(--card-bg);border-radius:var(--radius);
padding:16px;text-align:center;box-shadow:var(--shadow);
cursor:pointer;transition:transform .2s,box-shadow .2s;
display:flex;flex-direction:column;align-items:center;gap:8px;
}
.game-card:active{transform:scale(.97);}
.game-card-icon{font-size:2rem;}
.game-card-name{font-weight:700;font-size:1rem;}
.game-card-best{font-size:.8rem;color:#888;}
.game-card-medal{font-size:1.2rem;}
.hub-nav{
display:flex;gap:8px;width:100%;margin-top:8px;
}
.hub-nav button{flex:1;font-size:.9rem;padding:10px 8px;}

/* Game shared */
.game-header{
width:100%;display:flex;justify-content:space-between;align-items:center;
padding:8px 0;margin-bottom:12px;
}
.game-back{background:none;padding:8px;font-size:1.2rem;min-width:44px;}
.game-title{font-weight:700;font-size:1.1rem;}
.game-info{font-size:.9rem;color:#555;font-weight:600;}
.game-progress{
width:100%;height:6px;background:#e0e0e0;border-radius:3px;
margin-bottom:16px;overflow:hidden;
}
.game-progress-bar{
height:100%;background:linear-gradient(90deg,var(--blue),var(--green));
border-radius:3px;transition:width .3s;
}
.game-question{
text-align:center;margin:16px 0;width:100%;
}
.game-options{
display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;
margin-top:16px;
}
.game-option{
padding:16px 12px;border:2px solid #e0e0e0;border-radius:14px;
background:#fff;font-size:1rem;font-weight:600;
transition:all .2s;text-align:center;word-break:keep-all;
}
.game-option.correct{border-color:var(--green);background:#e6f9e6;color:var(--green);}
.game-option.wrong{border-color:var(--red);background:#ffe6e6;color:var(--red);}
.game-option.disabled{pointer-events:none;opacity:.7;}
.game-option.hanja-opt{font-size:clamp(28px,7vw,48px);}

/* Timer bar */
.timer-bar{
width:100%;height:8px;background:#e0e0e0;border-radius:4px;
margin-bottom:12px;overflow:hidden;
}
.timer-bar-inner{
height:100%;background:var(--green);border-radius:4px;
transition:width .1s linear,background .3s;
}
.timer-bar-inner.warning{background:var(--yellow);}
.timer-bar-inner.danger{background:var(--red);}

/* Gymnastics cards */
.gym-grid{
display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
width:100%;max-width:400px;margin:12px auto;
}
.gym-card-wrapper{
perspective:600px;aspect-ratio:3/4;cursor:pointer;
}
.gym-card{
width:100%;height:100%;position:relative;
transform-style:preserve-3d;transition:transform .5s;
}
.gym-card.flipped{transform:rotateY(180deg);}
.gym-card-face{
position:absolute;width:100%;height:100%;
backface-visibility:hidden;-webkit-backface-visibility:hidden;
border-radius:12px;display:flex;align-items:center;justify-content:center;
font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.1);
}
.gym-card-front{
background:linear-gradient(135deg,var(--blue),#4a90d9);color:#fff;
font-size:1.5rem;
}
.gym-card-back{
background:#fff;border:2px solid #e0e0e0;
transform:rotateY(180deg);
font-size:clamp(20px,6vw,36px);
}
.gym-card.matched .gym-card-back{
border-color:var(--green);background:#e6f9e6;
}

/* Marathon */
.marathon-track{
width:100%;height:40px;background:#e8e8e4;border-radius:20px;
position:relative;overflow:hidden;margin:12px 0;
}
.marathon-runner{
position:absolute;top:4px;left:0;width:32px;height:32px;
background:var(--blue);border-radius:50%;
display:flex;align-items:center;justify-content:center;
font-size:.9rem;transition:left .5s;
}
.marathon-flag{
position:absolute;right:8px;top:50%;transform:translateY(-50%);
font-size:1.2rem;
}

/* Result */
#screen-result{justify-content:center;gap:20px;}
.result-medal{font-size:5rem;animation:medalDrop .8s ease both;}
.result-title{font-size:1.6rem;font-weight:800;}
.result-score{font-size:2.5rem;font-weight:900;color:var(--blue);}
.result-detail{font-size:1rem;color:#666;text-align:center;}
.result-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;}
.confetti-piece{
position:fixed;width:10px;height:10px;top:-10px;
animation:confettiFall 2.5s linear forwards;
z-index:9999;pointer-events:none;
}

/* Leaderboard */
#screen-leaderboard{gap:12px;padding-top:16px;}
.lb-tabs{display:flex;gap:0;width:100%;border-radius:12px;overflow:hidden;background:#e8e8e4;flex-shrink:0;}
.lb-tab{
flex:1;padding:10px 4px;text-align:center;font-weight:600;
background:transparent;border-radius:0;color:#888;font-size:.85rem;
white-space:nowrap;
}
.lb-tab.active{background:var(--blue);color:#fff;}
.lb-list{width:100%;display:flex;flex-direction:column;gap:8px;flex:1;overflow-y:auto;}
.lb-item{
display:flex;align-items:center;gap:12px;padding:12px 16px;
background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);
}
.lb-rank{font-weight:800;font-size:1.2rem;min-width:32px;text-align:center;}
.lb-rank.gold{color:var(--gold);}
.lb-rank.silver{color:var(--silver);}
.lb-rank.bronze{color:var(--bronze);}
.lb-icon{font-size:1.4rem;}
.lb-info{flex:1;}
.lb-name{font-weight:700;font-size:.95rem;}
.lb-score{font-size:.8rem;color:#888;}
.lb-change{font-size:.8rem;font-weight:700;min-width:40px;text-align:right;}
.lb-change.up{color:var(--green);}
.lb-change.down{color:var(--red);}
.lb-change.same{color:#aaa;}
.lb-change.new{color:var(--blue);}
.lb-me{border:2px solid var(--blue);background:#f0f8ff;}

/* Profile */
#screen-profile{gap:16px;padding-top:16px;}
.profile-header{text-align:center;}
.profile-icon{font-size:3rem;}
.profile-name{font-size:1.4rem;font-weight:800;margin-top:4px;}
.profile-medals{
display:flex;justify-content:center;gap:20px;margin:12px 0;
}
.profile-medal-item{text-align:center;}
.profile-medal-icon{font-size:1.8rem;}
.profile-medal-count{font-weight:800;font-size:1.2rem;}
.profile-medal-label{font-size:.75rem;color:#888;}
.profile-section{width:100%;}
.profile-section-title{font-weight:700;font-size:1rem;margin-bottom:8px;padding-left:4px;}
.profile-game-row{
display:flex;justify-content:space-between;align-items:center;
padding:10px 12px;background:#fff;border-radius:10px;margin-bottom:6px;
box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.profile-progress-bar{
width:100%;height:10px;background:#e0e0e0;border-radius:5px;overflow:hidden;margin-top:8px;
}
.profile-progress-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));border-radius:5px;transition:width .5s;}
.profile-wrong-item{
display:flex;align-items:center;gap:12px;padding:10px;
background:#fff;border-radius:10px;margin-bottom:6px;
}
.profile-wrong-hanja{font-size:1.5rem;font-weight:700;width:40px;text-align:center;}
.profile-wrong-info{flex:1;font-size:.85rem;}
.profile-wrong-count{font-weight:700;color:var(--red);font-size:.85rem;}

/* Study */
#screen-study{gap:12px;padding-top:16px;}
.study-filters{
display:flex;flex-wrap:wrap;gap:6px;width:100%;margin-bottom:8px;
}
.study-filter{
padding:6px 14px;border-radius:20px;font-size:.8rem;
border:2px solid #ddd;background:#fff;color:#555;font-weight:600;
}
.study-filter.active{border-color:var(--blue);background:var(--blue);color:#fff;}
.study-card-container{
perspective:800px;width:100%;max-width:320px;aspect-ratio:3/4;
margin:8px auto;cursor:pointer;
}
.study-card{
width:100%;height:100%;position:relative;
transform-style:preserve-3d;transition:transform .6s;
}
.study-card.flipped{transform:rotateY(180deg);}
.study-card-face{
position:absolute;width:100%;height:100%;
backface-visibility:hidden;-webkit-backface-visibility:hidden;
border-radius:var(--radius);display:flex;flex-direction:column;
align-items:center;justify-content:center;gap:8px;
box-shadow:var(--shadow);padding:20px;
}
.study-front{background:#fff;}
.study-back{background:#f9f9f5;transform:rotateY(180deg);}
.study-hanja{font-size:clamp(60px,15vw,120px);line-height:1.1;}
.study-huneum{font-size:1.3rem;font-weight:700;color:var(--blue);}
.study-category{font-size:.8rem;color:#999;background:#f0f0f0;padding:4px 12px;border-radius:12px;}
.study-nav{display:flex;gap:12px;align-items:center;}
.study-nav button{width:48px;height:48px;border-radius:50%;font-size:1.3rem;padding:0;}
.study-counter{font-weight:600;color:#666;min-width:80px;text-align:center;}
.study-section{width:100%;}
.study-section-title{font-weight:700;font-size:1.05rem;margin:12px 0 8px 4px;}
.idiom-card{
background:#fff;border-radius:12px;padding:14px;margin-bottom:8px;
box-shadow:0 1px 4px rgba(0,0,0,.06);
}
.idiom-hanja{font-size:1.4rem;font-weight:700;margin-bottom:4px;}
.idiom-reading{font-size:.9rem;color:var(--blue);font-weight:600;}
.idiom-meaning{font-size:.85rem;color:#666;margin-top:4px;}
.antonym-grid{
display:grid;grid-template-columns:1fr 1fr;gap:8px;
}
.antonym-pair{
background:#fff;border-radius:12px;padding:12px;text-align:center;
box-shadow:0 1px 4px rgba(0,0,0,.06);
}
.antonym-hanja{font-size:1.3rem;font-weight:700;letter-spacing:8px;}
.antonym-reading{font-size:.8rem;color:#888;margin-top:4px;}

/* Weightlifting visual */
.weight-display{
text-align:center;margin:12px 0;
}
.weight-kg{font-size:2.5rem;font-weight:900;color:var(--red);}
.weight-label{font-size:.85rem;color:#888;}
.weight-bar{
width:80%;max-width:280px;margin:8px auto;height:12px;
background:#ddd;border-radius:6px;position:relative;
}
.weight-bar::before,.weight-bar::after{
content:'';position:absolute;top:-8px;width:28px;height:28px;
background:var(--red);border-radius:50%;
}
.weight-bar::before{left:-14px;}
.weight-bar::after{right:-14px;}

/* Daily done */
.daily-done{text-align:center;padding:24px 0;}
.daily-done-medal{font-size:3rem;margin-bottom:8px;}
.daily-countdown{font-size:1.2rem;font-weight:700;color:var(--blue);margin-top:8px;}

/* Scrollable area */
.scroll-area{
flex:1;width:100%;overflow-y:auto;-webkit-overflow-scrolling:touch;
padding-bottom:20px;
}

/* Hide scrollbar */
.scroll-area::-webkit-scrollbar{display:none;}
.scroll-area{-ms-overflow-style:none;scrollbar-width:none;}

/* Full width buttons */
.full-width{width:100%;}

/* ===== ARCADE GAME STYLES ===== */
.archery-arena{width:100%;max-width:280px;margin:0 auto 8px;}
.archery-target{width:100%;aspect-ratio:1;border-radius:50%;position:relative;overflow:hidden;box-shadow:0 6px 30px rgba(0,0,0,.25);background:#fff;}
.target-ring{position:absolute;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);}
.t-r5{width:100%;height:100%;background:#fff;border:3px solid #ccc;}
.t-r4{width:80%;height:80%;background:#a8d8ea;}
.t-r3{width:60%;height:60%;background:#EE334E;}
.t-r2{width:40%;height:40%;background:#FCB131;}
.t-r1{width:20%;height:20%;background:#EE334E;}
.t-bull{width:8%;height:8%;background:#FFD700;z-index:2;}
.archery-hanja{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(28px,7vw,48px);z-index:5;font-weight:700;text-shadow:0 0 12px #fff,0 0 24px #fff;}
.crosshair{position:absolute;width:40px;height:40px;z-index:10;pointer-events:none;transform:translate(-50%,-50%);}
.crosshair::before,.crosshair::after{content:'';position:absolute;background:rgba(255,0,0,.7);}
.crosshair::before{width:2px;height:100%;left:50%;transform:translateX(-50%);}
.crosshair::after{height:2px;width:100%;top:50%;transform:translateY(-50%);}
.crosshair-dot{position:absolute;width:6px;height:6px;background:red;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);}
.arrow-marker{position:absolute;width:10px;height:10px;border-radius:50%;transform:translate(-50%,-50%);z-index:8;border:2px solid #fff;animation:arrowPop .3s ease both;}
.arrow-marker.hit{background:var(--green);}.arrow-marker.miss{background:var(--red);}
@keyframes arrowPop{from{transform:translate(-50%,-50%) scale(0);}to{transform:translate(-50%,-50%) scale(1);}}
.score-popup{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:1.6rem;font-weight:900;z-index:20;animation:scoreFloat .8s ease both;pointer-events:none;}
@keyframes scoreFloat{0%{opacity:1;transform:translate(-50%,-50%) scale(.5);}50%{transform:translate(-50%,-80%) scale(1.2);}100%{opacity:0;transform:translate(-50%,-120%) scale(.8);}}
.swim-pool{width:100%;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#0077B6,#00B4D8);position:relative;box-shadow:0 4px 20px rgba(0,0,0,.2);}
.swim-lane{height:50px;position:relative;border-bottom:2px solid rgba(255,255,255,.15);display:flex;align-items:center;}
.swim-lane:last-child{border-bottom:none;}.swim-lane.player-lane{background:rgba(255,255,255,.08);}
.swim-swimmer{position:absolute;font-size:1.4rem;z-index:2;transition:left .35s ease;filter:drop-shadow(0 2px 3px rgba(0,0,0,.3));}
.swim-swimmer.boost{animation:swimBoost .3s ease;}
@keyframes swimBoost{0%{transform:scale(1);}50%{transform:scale(1.4) translateX(5px);}100%{transform:scale(1);}}
.swim-name{position:absolute;left:4px;top:2px;font-size:.6rem;color:rgba(255,255,255,.8);font-weight:700;z-index:3;}
.swim-finish{position:absolute;right:0;top:0;bottom:0;width:6px;background:repeating-linear-gradient(180deg,#000 0 4px,#fff 4px 8px);z-index:4;}
.swim-wave{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;background:repeating-linear-gradient(90deg,transparent 0,transparent 46px,rgba(255,255,255,.06) 46px,rgba(255,255,255,.06) 50px);animation:waveDrift 2s linear infinite;}
@keyframes waveDrift{from{transform:translateX(0);}to{transform:translateX(50px);}}
.wl-stage{width:100%;text-align:center;position:relative;padding:8px 0;}
.wl-lifter{font-size:3.5rem;display:inline-block;transition:transform .3s;}
.wl-lifter.lifting{animation:liftAnim .6s ease;}.wl-lifter.fail{animation:failAnim .5s ease;}
@keyframes liftAnim{0%{transform:translateY(0);}40%{transform:translateY(-30px) scale(1.1);}100%{transform:translateY(0);}}
@keyframes failAnim{0%{transform:rotate(0);}30%{transform:rotate(-8deg) translateY(3px);}60%{transform:rotate(8deg);}100%{transform:rotate(0);}}
.wl-plates{display:flex;align-items:center;justify-content:center;margin:8px auto;}
.wl-plate{border-radius:3px;animation:plateAdd .3s ease both;}
@keyframes plateAdd{from{transform:scaleY(0);}to{transform:scaleY(1);}}
.wl-bar{width:100px;height:8px;background:#666;border-radius:4px;flex-shrink:0;}
.wl-gauge{width:80%;max-width:260px;height:22px;background:#e0e0e0;border-radius:11px;margin:8px auto;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);}
.wl-gauge-fill{height:100%;border-radius:11px;transition:width .4s;background:linear-gradient(90deg,#00A651,#FCB131,#EE334E);}
.wl-gauge-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:800;font-size:.7rem;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5);}
.screen-shake{animation:screenShake .4s ease;}
@keyframes screenShake{0%,100%{transform:translateX(0);}25%{transform:translateX(-8px);}50%{transform:translateX(8px);}75%{transform:translateX(-4px);}}
.gym-card-front{background:linear-gradient(135deg,#667eea,#764ba2)!important;font-size:1.8rem!important;box-shadow:0 4px 12px rgba(102,126,234,.4)!important;}
.gym-combo{text-align:center;font-weight:800;font-size:1.2rem;color:var(--gold);min-height:28px;}
.gym-combo.active{animation:comboPulse .3s ease;}
@keyframes comboPulse{0%{transform:scale(1);}50%{transform:scale(1.3);}100%{transform:scale(1);}}
.marathon-scene{width:100%;height:160px;position:relative;overflow:hidden;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.15);}
.marathon-sky{position:absolute;top:0;left:0;right:0;height:55%;background:linear-gradient(180deg,#87CEEB,#B0E0E6);}
.marathon-ground{position:absolute;bottom:0;left:0;right:0;height:45%;background:linear-gradient(180deg,#90EE90,#6B8E23);}
.marathon-trees{position:absolute;bottom:45%;left:0;white-space:nowrap;transition:transform .5s ease;font-size:1.5rem;}
.marathon-road{position:absolute;bottom:0;left:0;right:0;height:25%;background:#777;border-top:3px solid #999;}
.marathon-road-line{position:absolute;top:45%;left:0;right:0;height:3px;background:repeating-linear-gradient(90deg,#FFD700 0 20px,transparent 20px 40px);animation:roadScroll .8s linear infinite;}
@keyframes roadScroll{from{transform:translateX(0);}to{transform:translateX(-40px);}}
.marathon-road-line.paused{animation-play-state:paused;}
.marathon-runner-sprite{position:absolute;bottom:25%;left:15%;font-size:2.2rem;z-index:5;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));}
.marathon-runner-sprite.running{animation:runBounce .35s ease infinite;}
@keyframes runBounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.marathon-runner-sprite.stumble{animation:stumbleAnim .5s ease;}
@keyframes stumbleAnim{0%{transform:rotate(0);}25%{transform:rotate(15deg) translateY(-5px);}50%{transform:rotate(-10deg);}100%{transform:rotate(0);}}
.marathon-km{position:absolute;bottom:27%;font-size:.65rem;font-weight:800;color:#fff;background:rgba(0,0,0,.5);padding:2px 6px;border-radius:4px;transition:left .5s;z-index:3;}
.marathon-dist{font-size:1.5rem;font-weight:900;text-align:center;background:linear-gradient(135deg,var(--blue),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:6px 0;}
.marathon-clouds{position:absolute;top:8%;left:0;white-space:nowrap;animation:cloudDrift 25s linear infinite;font-size:1.2rem;opacity:.5;}
@keyframes cloudDrift{from{transform:translateX(100vw);}to{transform:translateX(-200vw);}}

/* ===== ARCADE EFFECTS V3 ===== */
.shake-light{animation:shakeL .2s ease;}
.shake-medium{animation:shakeM .3s ease;}
.shake-heavy{animation:shakeH .5s ease;}
@keyframes shakeL{0%,100%{transform:translate(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}}
@keyframes shakeM{0%,100%{transform:translate(0)}20%{transform:translate(-8px,3px)}40%{transform:translate(8px,-3px)}60%{transform:translate(-6px,2px)}80%{transform:translate(4px,-1px)}}
@keyframes shakeH{0%,100%{transform:translate(0)}10%{transform:translate(-12px,6px) rotate(-2deg)}30%{transform:translate(12px,-6px) rotate(2deg)}50%{transform:translate(-10px,4px) rotate(-1deg)}70%{transform:translate(8px,-3px) rotate(1deg)}90%{transform:translate(-4px,2px)}}
.flash-overlay{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:9998;opacity:0;transition:opacity .05s;}
.flash-overlay.active{opacity:1;animation:flashFade .2s ease forwards;}
@keyframes flashFade{0%{opacity:.6;}100%{opacity:0;}}
.flash-green{background:rgba(0,166,81,.4);}.flash-red{background:rgba(238,51,78,.4);}
.flash-gold{background:rgba(255,215,0,.5);animation-duration:.35s!important;}.flash-white{background:rgba(255,255,255,.8);}
.particle{position:fixed;pointer-events:none;z-index:9997;border-radius:50%;}
.particle.sparkle{width:8px;height:8px;animation:sparkleOut .6s ease forwards;}
.particle.splash-p{width:6px;height:6px;background:#00B4D8;animation:splashUp .5s ease forwards;}
.particle.dust-p{width:12px;height:12px;background:rgba(150,130,100,.6);border-radius:50%;animation:dustCloud .7s ease forwards;}
.particle.heart-break{width:10px;height:10px;font-size:10px;line-height:1;animation:heartBreakAnim .6s ease forwards;}
@keyframes sparkleOut{0%{transform:translate(0) scale(1);opacity:1;}100%{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0;}}
@keyframes splashUp{0%{transform:translate(0) scale(1);opacity:1;}50%{transform:translate(var(--dx),-40px) scale(1.2);}100%{transform:translate(var(--dx2,var(--dx)),20px) scale(.5);opacity:0;}}
@keyframes dustCloud{0%{transform:translate(0) scale(.5);opacity:.8;}100%{transform:translate(var(--dx),-30px) scale(2);opacity:0;}}
@keyframes heartBreakAnim{0%{transform:translate(0) scale(1);opacity:1;}100%{transform:translate(var(--dx),var(--dy)) scale(0) rotate(var(--rot,180deg));opacity:0;}}
.countdown-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:none;}
.countdown-text{font-size:6rem;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,215,0,.8);animation:countPop .6s ease both;}
.countdown-text.go{font-size:4rem;color:#FFD700;}
@keyframes countPop{0%{transform:scale(2);opacity:0;}50%{transform:scale(1.1);opacity:1;}100%{transform:scale(1);opacity:.9;}}
.combo-display{position:absolute;top:60px;left:50%;transform:translateX(-50%);font-weight:900;z-index:100;pointer-events:none;text-align:center;white-space:nowrap;}
.combo-display .combo-text{animation:comboFloat .8s ease both;}
@keyframes comboFloat{0%{transform:scale(.5);opacity:0;}30%{transform:scale(1.3);opacity:1;}100%{transform:scale(1);opacity:.8;}}
.text-popup{position:absolute;pointer-events:none;font-weight:900;z-index:100;animation:textPop .8s ease both;text-shadow:0 2px 4px rgba(0,0,0,.3);}
@keyframes textPop{0%{transform:translateY(0) scale(.5);opacity:0;}30%{transform:translateY(-10px) scale(1.2);opacity:1;}100%{transform:translateY(-40px) scale(.9);opacity:0;}}
.hp-bar{display:flex;gap:4px;justify-content:center;margin:6px 0;}
.hp-heart{font-size:1.6rem;transition:transform .2s,opacity .2s;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));}
.hp-heart.lost{animation:heartLost .5s ease both;}
.hp-heart.heal{animation:heartHeal .4s ease both;}
@keyframes heartLost{0%{transform:scale(1);}30%{transform:scale(1.4);}100%{transform:scale(0) rotate(180deg);opacity:0;}}
@keyframes heartHeal{0%{transform:scale(0);opacity:0;}50%{transform:scale(1.3);}100%{transform:scale(1);opacity:1;}}
.power-gauge-v3{width:90%;max-width:300px;height:36px;margin:12px auto;border-radius:18px;position:relative;overflow:hidden;box-shadow:inset 0 3px 6px rgba(0,0,0,.2),0 2px 8px rgba(0,0,0,.1);background:linear-gradient(90deg,#EE334E 0%,#EE334E 30%,#FCB131 30%,#FCB131 60%,#00A651 60%,#00A651 85%,#FFD700 85%,#FFD700 100%);}
.power-gauge-v3 .gauge-needle{position:absolute;top:0;bottom:0;width:4px;background:#fff;box-shadow:0 0 8px rgba(255,255,255,.8);transition:none;z-index:2;}
.power-gauge-v3 .gauge-zones{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;font-size:.6rem;font-weight:800;color:rgba(255,255,255,.7);}
.power-gauge-v3 .gauge-zones span{display:flex;align-items:center;justify-content:center;}
.speed-indicator{text-align:center;font-weight:900;padding:4px 16px;border-radius:20px;font-size:.85rem;display:inline-block;transition:all .3s;}
.speed-jog{background:#e8f5e9;color:#4CAF50;}.speed-run{background:#fff3e0;color:#FF9800;}
.speed-sprint{background:#fce4ec;color:#E91E63;}.speed-max{background:linear-gradient(135deg,#FFD700,#FF6B6B);color:#fff;animation:speedPulse .5s ease infinite;}
@keyframes speedPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
.vignette-red{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:9990;box-shadow:inset 0 0 80px 30px rgba(238,51,78,.4);animation:vignetteFlash 1s ease infinite;}
@keyframes vignetteFlash{0%,100%{opacity:.3;}50%{opacity:.7;}}
.rain-effect{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10;background:repeating-linear-gradient(180deg,transparent,transparent 10px,rgba(100,150,255,.1) 10px,rgba(100,150,255,.1) 12px);animation:rainFall .3s linear infinite;}
@keyframes rainFall{from{transform:translateY(-12px);}to{transform:translateY(0);}}
.obstacle-banner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);color:#FFD700;font-weight:900;font-size:1.2rem;padding:12px 24px;border-radius:12px;z-index:50;animation:bannerPop .4s ease both;text-align:center;white-space:nowrap;}
@keyframes bannerPop{0%{transform:translate(-50%,-50%) scale(0);}50%{transform:translate(-50%,-50%) scale(1.1);}100%{transform:translate(-50%,-50%) scale(1);}}
.shoot-btn{font-size:1.5rem;padding:16px 48px;border-radius:50%;background:linear-gradient(135deg,#EE334E,#FF6B6B);color:#fff;box-shadow:0 6px 20px rgba(238,51,78,.4);animation:shootPulse .8s ease infinite;border:3px solid rgba(255,255,255,.3);}
@keyframes shootPulse{0%,100%{transform:scale(1);box-shadow:0 6px 20px rgba(238,51,78,.4);}50%{transform:scale(1.05);box-shadow:0 8px 30px rgba(238,51,78,.6);}}
.judge-panel{display:flex;justify-content:center;gap:12px;margin:8px 0;}
.judge{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:3px solid #ddd;transition:all .3s;}
.judge.ok{border-color:#00A651;background:#e6f9e6;}.judge.fail{border-color:#EE334E;background:#ffe6e6;}
.wl-crack{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:2rem;opacity:0;animation:crackAppear .5s ease forwards;}
@keyframes crackAppear{0%{opacity:0;transform:translateX(-50%) scale(0);}50%{opacity:1;transform:translateX(-50%) scale(1.3);}100%{opacity:.7;transform:translateX(-50%) scale(1);}}
.rank-badge{position:absolute;top:2px;right:8px;font-weight:900;font-size:.85rem;padding:2px 8px;border-radius:8px;z-index:10;}
.rank-badge.r1{background:#FFD700;color:#333;}.rank-badge.r2{background:#C0C0C0;color:#333;}
.rank-badge.r3{background:#CD7F32;color:#fff;}.rank-badge.r4{background:#999;color:#fff;}
.timer-danger .game-header{animation:timerDangerPulse 1s ease infinite;}
@keyframes timerDangerPulse{0%,100%{background:transparent;}50%{background:rgba(238,51,78,.1);}}
.hit-stop{animation:hitStop .08s step-end forwards;}
@keyframes hitStop{0%,100%{filter:brightness(2);}}

/* ===== FULL-SCREEN GAME LAYOUT ===== */
.game-full{position:relative;width:100%;height:100vh;height:100dvh;overflow:hidden;-webkit-user-select:none;user-select:none;}
.game-full *{-webkit-user-select:none;user-select:none;}
.game-hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;z-index:50;pointer-events:none;}
.game-hud>*{pointer-events:auto;}
.game-hud-back{width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,.4);color:#fff;font-size:1.2rem;display:flex;align-items:center;justify-content:center;border:none;padding:0;backdrop-filter:blur(4px);}
.game-hud-info{display:flex;gap:8px;align-items:center;color:#fff;font-weight:800;font-size:.95rem;text-shadow:0 2px 4px rgba(0,0,0,.5);}
.game-hud-progress{position:absolute;top:0;left:0;right:0;height:4px;background:rgba(255,255,255,.15);z-index:51;}
.game-hud-progress-bar{height:100%;background:linear-gradient(90deg,#00E5FF,#76FF03);transition:width .3s;border-radius:0 2px 2px 0;}
.game-scene{position:absolute;top:0;left:0;right:0;bottom:0;}
.game-question-overlay{position:absolute;top:52px;left:50%;transform:translateX(-50%);text-align:center;z-index:30;pointer-events:none;}
.game-question-label{font-size:.8rem;color:rgba(255,255,255,.6);margin-bottom:4px;}
.game-question-text{font-size:1.4rem;font-weight:800;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.5);}
.game-answers{position:absolute;bottom:0;left:0;right:0;padding:12px;z-index:40;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.game-ans-btn{
padding:18px 10px;border-radius:16px;font-size:1.15rem;font-weight:800;
border:2px solid rgba(255,255,255,.2);color:#fff;text-align:center;
background:rgba(255,255,255,.12);backdrop-filter:blur(8px);
transition:all .15s;min-height:56px;display:flex;align-items:center;justify-content:center;
text-shadow:0 1px 3px rgba(0,0,0,.4);
}
.game-ans-btn:active{transform:scale(.95);background:rgba(255,255,255,.25);}
.game-ans-btn.correct-ans{background:rgba(0,166,81,.7)!important;border-color:#00A651!important;animation:ansCorrect .3s ease;}
.game-ans-btn.wrong-ans{background:rgba(238,51,78,.7)!important;border-color:#EE334E!important;animation:ansWrong .3s ease;}
.game-ans-btn.disabled-ans{pointer-events:none;opacity:.5;}
.game-ans-btn.hanja-lg{font-size:clamp(32px,8vw,52px);}
@keyframes ansCorrect{0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);}}
@keyframes ansWrong{0%{transform:translateX(0);}25%{transform:translateX(-6px);}50%{transform:translateX(6px);}75%{transform:translateX(-3px);}100%{transform:translateX(0);}}
.archery-bg{background:radial-gradient(ellipse at 50% 45%,#1a1a3e,#0a0a1e);}
.archery-target-lg{position:absolute;top:50%;left:50%;transform:translate(-50%,-55%);width:min(72vw,320px);aspect-ratio:1;border-radius:50%;overflow:visible;}
.swim-bg{background:linear-gradient(180deg,#003459 0%,#00171f 15%,#005f8f 20%,#007ea7 25%,#00a8e8 50%,#00a8e8 80%,#003459 100%);}
.swim-lanes-full{position:absolute;top:15%;left:0;right:0;height:40%;}
.swim-lane-full{height:25%;position:relative;border-bottom:2px solid rgba(255,255,255,.1);display:flex;align-items:center;}
.swim-lane-full.player-lane-full{background:rgba(255,255,255,.05);}
.swim-emoji{position:absolute;font-size:1.8rem;transition:left .3s ease;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5));}
.swim-label{position:absolute;left:6px;top:2px;font-size:.65rem;color:rgba(255,255,255,.7);font-weight:800;}
.swim-finish-full{position:absolute;right:0;top:0;height:100%;width:8px;background:repeating-linear-gradient(180deg,#000 0 5px,#fff 5px 10px);z-index:5;}
.swim-rank{position:absolute;right:12px;font-size:.8rem;font-weight:900;padding:2px 8px;border-radius:8px;z-index:5;}
.wl-bg{background:radial-gradient(ellipse at 50% 70%,#2a1a0a,#0a0a0a);}
.wl-spotlight{position:absolute;top:0;left:50%;transform:translateX(-50%);width:200%;height:60%;background:radial-gradient(ellipse at 50% 0%,rgba(255,220,100,.15),transparent 60%);pointer-events:none;}
.wl-lifter-lg{position:absolute;top:42%;left:50%;transform:translate(-50%,-50%);font-size:5rem;z-index:10;filter:drop-shadow(0 4px 12px rgba(0,0,0,.5));}
.wl-barbell-visual{position:absolute;top:32%;left:50%;transform:translateX(-50%);display:flex;align-items:center;z-index:5;}
.wl-kg-display{position:absolute;top:20%;left:50%;transform:translateX(-50%);font-size:3rem;font-weight:900;color:#FFD700;text-shadow:0 0 20px rgba(255,215,0,.5);z-index:20;}
.gym-bg{background:linear-gradient(135deg,#1a0a2e,#2d1b69,#1a0a2e);}
.gym-grid-full{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:min(92vw,380px);z-index:10;}
.gym-card-lg{aspect-ratio:2.5/3.5;perspective:600px;cursor:pointer;}
.gym-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .4s;}
.gym-card-inner.flipped{transform:rotateY(180deg);}
.gym-card-inner.matched .gym-back-lg{border-color:#76FF03;box-shadow:0 0 15px rgba(118,255,3,.4);}
.gym-front-lg,.gym-back-lg{position:absolute;width:100%;height:100%;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;}
.gym-front-lg{background:linear-gradient(135deg,#6C63FF,#E040FB);color:rgba(255,255,255,.8);font-size:1.6rem;box-shadow:0 4px 15px rgba(108,99,255,.4);}
.gym-back-lg{background:rgba(255,255,255,.95);border:2px solid #ddd;transform:rotateY(180deg);padding:4px;}
.gym-timer-circle{position:absolute;top:56px;right:14px;width:52px;height:52px;border-radius:50%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1rem;color:#fff;z-index:20;backdrop-filter:blur(4px);}
.gym-timer-circle.danger{color:#EE334E;animation:timerDangerPulse 1s ease infinite;box-shadow:0 0 15px rgba(238,51,78,.5);}
.marathon-bg{background:linear-gradient(180deg,#87CEEB 0%,#B0E0E6 30%,#90EE90 45%,#6B8E23 55%,#555 65%,#777 70%,#555 100%);}
.marathon-scene-full{position:absolute;top:0;left:0;right:0;height:60%;overflow:hidden;}
.marathon-road-full{position:absolute;bottom:0;left:0;right:0;height:35%;background:linear-gradient(180deg,#888,#666);border-top:4px solid #999;}
.marathon-road-lines{position:absolute;top:45%;left:0;right:0;height:4px;background:repeating-linear-gradient(90deg,#FFD700 0 25px,transparent 25px 50px);animation:roadScrollFast .6s linear infinite;}
@keyframes roadScrollFast{from{transform:translateX(0);}to{transform:translateX(-50px);}}
.marathon-runner-lg{position:absolute;bottom:35%;left:18%;font-size:3.5rem;z-index:15;filter:drop-shadow(0 4px 8px rgba(0,0,0,.4));}
.marathon-runner-lg.running{animation:runBounceLg .3s ease infinite;}
@keyframes runBounceLg{0%,100%{transform:translateY(0);}50%{transform:translateY(-12px);}}
.marathon-runner-lg.stumble{animation:stumbleLg .5s ease;}
@keyframes stumbleLg{0%{transform:rotate(0);}25%{transform:rotate(20deg) translateY(-8px);}50%{transform:rotate(-15deg);}100%{transform:rotate(0);}}
.marathon-hp{position:absolute;top:56px;left:14px;display:flex;gap:3px;z-index:20;}
.marathon-speed{position:absolute;top:56px;left:50%;transform:translateX(-50%);z-index:20;}
.marathon-km-full{position:absolute;top:58px;right:14px;font-weight:900;font-size:1rem;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.5);z-index:20;}
.screen.game-screen-active{padding:0!important;}

/* ==== HUB DARK GAME THEME ==== */
#screen-hub{background:linear-gradient(135deg,#0a0a2e 0%,#1a1050 50%,#0a0a2e 100%)!important;}
#screen-hub .hub-title{color:#fff;text-shadow:0 0 20px rgba(100,100,255,0.4);font-size:1.6rem;}
#screen-hub .hub-user-name{color:#fff;}
#screen-hub .hub-header{color:#fff;}
#screen-hub .game-card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#fff;box-shadow:0 4px 15px rgba(0,0,0,0.3);backdrop-filter:blur(4px);transition:all .2s;}
#screen-hub .game-card:active{border-color:rgba(100,100,255,0.5);box-shadow:0 0 20px rgba(100,100,255,0.3);}
#screen-hub .game-card-name{color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3);}
#screen-hub .game-card-best{color:rgba(255,255,255,0.5);}
#screen-hub .hub-nav button{background:rgba(255,255,255,0.08);color:#fff;border:1px solid rgba(255,255,255,0.15);}
#screen-hub .hub-nav button:active{background:rgba(255,255,255,0.15);}
#screen-hub .daily-card{background:linear-gradient(135deg,#4a0080,#7b2ff7)!important;box-shadow:0 4px 20px rgba(123,47,247,0.4);}
#screen-hub .daily-card-title,#screen-hub .daily-card-info,#screen-hub .daily-streak{color:#fff;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
<div class="app-container">

<!-- Splash -->
<div class="screen active" id="screen-splash" style="padding:0;background:#080820;overflow:hidden;position:relative;">
  <canvas id="splash3d" style="position:absolute;top:0;left:0;width:100%;height:100%;"></canvas>
  <div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;pointer-events:none;">
    <div style="font-size:3rem;font-weight:900;color:#FFD700;text-shadow:0 0 30px rgba(255,215,0,.6),0 4px 8px rgba(0,0,0,.5);letter-spacing:4px;">한자 올림픽</div>
    <div style="font-size:1rem;color:rgba(255,255,255,.7);margin-top:12px;text-shadow:0 2px 4px rgba(0,0,0,.5);">한자와 함께하는 즐거운 도전</div>
    <div id="splash-loading" style="margin-top:24px;font-size:.8rem;color:rgba(255,255,255,.4);">로딩 중...</div>
  </div>
</div>

<!-- Auth -->
<div class="screen" id="screen-auth">
  <div class="title-lg" style="margin-bottom:8px;">한자 올림픽</div>
  <div class="subtitle" style="margin-bottom:16px;">계정을 만들고 도전을 시작하세요</div>
  <div class="auth-tabs" id="auth-tabs">
    <button class="auth-tab active" data-tab="login">로그인</button>
    <button class="auth-tab" data-tab="register">회원가입</button>
  </div>
  <div class="auth-form" id="auth-form"></div>
  <div class="auth-error" id="auth-error"></div>
</div>

<!-- Hub -->
<div class="screen" id="screen-hub">
  <div class="hub-header">
    <div class="hub-user">
      <span class="hub-user-icon" id="hub-user-icon"></span>
      <span class="hub-user-name" id="hub-user-name"></span>
    </div>
  </div>
  <div class="hub-title">올림픽 마을</div>
  <div id="hub-daily-card"></div>
  <div class="game-grid" id="hub-game-grid"></div>
  <div class="hub-nav">
    <button class="btn-outline" id="hub-btn-leaderboard">리더보드</button>
    <button class="btn-outline" id="hub-btn-profile">프로필</button>
    <button class="btn-outline" id="hub-btn-study">학습</button>
  </div>
</div>

<!-- Games -->
<div class="screen" id="screen-archery"></div>
<div class="screen" id="screen-swimming"></div>
<div class="screen" id="screen-weightlifting"></div>
<div class="screen" id="screen-gymnastics"></div>
<div class="screen" id="screen-marathon"></div>
<div class="screen" id="screen-daily"></div>
<div class="screen" id="screen-antonym"></div>
<div class="screen" id="screen-idiom"></div>
<div class="screen" id="screen-homonym"></div>

<!-- Result -->
<div class="screen" id="screen-result">
  <div id="result-content"></div>
</div>

<!-- Leaderboard -->
<div class="screen" id="screen-leaderboard">
  <div class="game-header" style="width:100%">
    <button class="game-back" id="lb-back">&#8592;</button>
    <span class="game-title">리더보드</span>
    <span style="width:44px"></span>
  </div>
  <div class="lb-tabs" id="lb-tabs"></div>
  <div class="lb-list scroll-area" id="lb-list"></div>
</div>

<!-- Profile -->
<div class="screen" id="screen-profile">
  <div class="game-header" style="width:100%">
    <button class="game-back" id="profile-back">&#8592;</button>
    <span class="game-title">프로필</span>
    <span style="width:44px"></span>
  </div>
  <div class="scroll-area" id="profile-content"></div>
</div>

<!-- Study -->
<div class="screen" id="screen-study">
  <div class="game-header" style="width:100%">
    <button class="game-back" id="study-back">&#8592;</button>
    <span class="game-title">학습 모드</span>
    <span style="width:44px"></span>
  </div>
  <div class="scroll-area" id="study-content"></div>
</div>


<!-- Game Canvas -->
<div id="game3d" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;touch-action:none;overflow:hidden;">
  <div id="game3d-ui" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:1001;pointer-events:none;display:flex;flex-direction:column;"></div>
</div>
</div>

<script>
// ============================
// DATA
// ============================
const HANJA_CORE=[
{hanja:"一",hun:"한",eum:"일",fullHunEum:"한 일",category:"숫자"},
{hanja:"二",hun:"두",eum:"이",fullHunEum:"두 이",category:"숫자"},
{hanja:"三",hun:"석",eum:"삼",fullHunEum:"석 삼",category:"숫자"},
{hanja:"四",hun:"넉",eum:"사",fullHunEum:"넉 사",category:"숫자"},
{hanja:"五",hun:"다섯",eum:"오",fullHunEum:"다섯 오",category:"숫자"},
{hanja:"六",hun:"여섯",eum:"육",fullHunEum:"여섯 육",category:"숫자"},
{hanja:"七",hun:"일곱",eum:"칠",fullHunEum:"일곱 칠",category:"숫자"},
{hanja:"八",hun:"여덟",eum:"팔",fullHunEum:"여덟 팔",category:"숫자"},
{hanja:"九",hun:"아홉",eum:"구",fullHunEum:"아홉 구",category:"숫자"},
{hanja:"十",hun:"열",eum:"십",fullHunEum:"열 십",category:"숫자"},
{hanja:"百",hun:"일백",eum:"백",fullHunEum:"일백 백",category:"숫자"},
{hanja:"千",hun:"일천",eum:"천",fullHunEum:"일천 천",category:"숫자"},
{hanja:"萬",hun:"일만",eum:"만",fullHunEum:"일만 만",category:"숫자"},
{hanja:"日",hun:"날",eum:"일",fullHunEum:"날 일",category:"자연"},
{hanja:"月",hun:"달",eum:"월",fullHunEum:"달 월",category:"자연"},
{hanja:"火",hun:"불",eum:"화",fullHunEum:"불 화",category:"자연"},
{hanja:"水",hun:"물",eum:"수",fullHunEum:"물 수",category:"자연"},
{hanja:"木",hun:"나무",eum:"목",fullHunEum:"나무 목",category:"자연"},
{hanja:"金",hun:"쇠",eum:"금",fullHunEum:"쇠 금",category:"자연"},
{hanja:"土",hun:"흙",eum:"토",fullHunEum:"흙 토",category:"자연"},
{hanja:"山",hun:"뫼",eum:"산",fullHunEum:"뫼 산",category:"자연"},
{hanja:"川",hun:"내",eum:"천",fullHunEum:"내 천",category:"자연"},
{hanja:"大",hun:"큰",eum:"대",fullHunEum:"큰 대",category:"크기/방향"},
{hanja:"小",hun:"작을",eum:"소",fullHunEum:"작을 소",category:"크기/방향"},
{hanja:"中",hun:"가운데",eum:"중",fullHunEum:"가운데 중",category:"크기/방향"},
{hanja:"上",hun:"위",eum:"상",fullHunEum:"위 상",category:"크기/방향"},
{hanja:"下",hun:"아래",eum:"하",fullHunEum:"아래 하",category:"크기/방향"},
{hanja:"左",hun:"왼",eum:"좌",fullHunEum:"왼 좌",category:"크기/방향"},
{hanja:"右",hun:"오른",eum:"우",fullHunEum:"오른 우",category:"크기/방향"},
{hanja:"人",hun:"사람",eum:"인",fullHunEum:"사람 인",category:"사람"},
{hanja:"女",hun:"계집",eum:"여",fullHunEum:"계집 여",category:"사람"},
{hanja:"子",hun:"아들",eum:"자",fullHunEum:"아들 자",category:"사람"},
{hanja:"王",hun:"임금",eum:"왕",fullHunEum:"임금 왕",category:"사람"},
{hanja:"兄",hun:"형",eum:"형",fullHunEum:"형 형",category:"사람"},
{hanja:"弟",hun:"아우",eum:"제",fullHunEum:"아우 제",category:"사람"},
{hanja:"玉",hun:"구슬",eum:"옥",fullHunEum:"구슬 옥",category:"개념"},
{hanja:"白",hun:"흰",eum:"백",fullHunEum:"흰 백",category:"개념"},
{hanja:"天",hun:"하늘",eum:"천",fullHunEum:"하늘 천",category:"개념"},
{hanja:"地",hun:"땅",eum:"지",fullHunEum:"땅 지",category:"개념"},
{hanja:"正",hun:"바를",eum:"정",fullHunEum:"바를 정",category:"개념"},
{hanja:"出",hun:"날",eum:"출",fullHunEum:"날 출",category:"개념"},
{hanja:"生",hun:"날",eum:"생",fullHunEum:"날 생",category:"개념"},
{hanja:"年",hun:"해",eum:"년",fullHunEum:"해 년",category:"개념"},
{hanja:"名",hun:"이름",eum:"명",fullHunEum:"이름 명",category:"개념"},
{hanja:"門",hun:"문",eum:"문",fullHunEum:"문 문",category:"개념"},
{hanja:"文",hun:"글월",eum:"문",fullHunEum:"글월 문",category:"개념"},
{hanja:"字",hun:"글자",eum:"자",fullHunEum:"글자 자",category:"개념"},
{hanja:"休",hun:"쉴",eum:"휴",fullHunEum:"쉴 휴",category:"개념"},
{hanja:"足",hun:"발",eum:"족",fullHunEum:"발 족",category:"개념"},
{hanja:"向",hun:"향할",eum:"향",fullHunEum:"향할 향",category:"개념"},
];

const HANJA_EXTRA=[
{hanja:"父",hun:"아비",eum:"부",fullHunEum:"아비 부",category:"가족"},
{hanja:"母",hun:"어미",eum:"모",fullHunEum:"어미 모",category:"가족"},
{hanja:"男",hun:"사내",eum:"남",fullHunEum:"사내 남",category:"가족"},
{hanja:"東",hun:"동녘",eum:"동",fullHunEum:"동녘 동",category:"방위"},
{hanja:"西",hun:"서녘",eum:"서",fullHunEum:"서녘 서",category:"방위"},
{hanja:"南",hun:"남녘",eum:"남",fullHunEum:"남녘 남",category:"방위"},
{hanja:"北",hun:"북녘",eum:"북",fullHunEum:"북녘 북",category:"방위"},
{hanja:"江",hun:"강",eum:"강",fullHunEum:"강 강",category:"자연"},
{hanja:"林",hun:"수풀",eum:"림",fullHunEum:"수풀 림",category:"자연"},
{hanja:"石",hun:"돌",eum:"석",fullHunEum:"돌 석",category:"자연"},
{hanja:"草",hun:"풀",eum:"초",fullHunEum:"풀 초",category:"자연"},
{hanja:"馬",hun:"말",eum:"마",fullHunEum:"말 마",category:"동물"},
{hanja:"牛",hun:"소",eum:"우",fullHunEum:"소 우",category:"동물"},
{hanja:"魚",hun:"물고기",eum:"어",fullHunEum:"물고기 어",category:"동물"},
{hanja:"羊",hun:"양",eum:"양",fullHunEum:"양 양",category:"동물"},
{hanja:"口",hun:"입",eum:"구",fullHunEum:"입 구",category:"신체"},
{hanja:"目",hun:"눈",eum:"목",fullHunEum:"눈 목",category:"신체"},
{hanja:"耳",hun:"귀",eum:"이",fullHunEum:"귀 이",category:"신체"},
{hanja:"手",hun:"손",eum:"수",fullHunEum:"손 수",category:"신체"},
{hanja:"心",hun:"마음",eum:"심",fullHunEum:"마음 심",category:"신체"},
{hanja:"國",hun:"나라",eum:"국",fullHunEum:"나라 국",category:"생활"},
{hanja:"市",hun:"저자",eum:"시",fullHunEum:"저자 시",category:"생활"},
{hanja:"車",hun:"수레",eum:"차",fullHunEum:"수레 차",category:"생활"},
{hanja:"食",hun:"밥",eum:"식",fullHunEum:"밥 식",category:"생활"},
{hanja:"衣",hun:"옷",eum:"의",fullHunEum:"옷 의",category:"생활"},
{hanja:"光",hun:"빛",eum:"광",fullHunEum:"빛 광",category:"생활"},
{hanja:"古",hun:"예",eum:"고",fullHunEum:"예 고",category:"기타"},
{hanja:"今",hun:"이제",eum:"금",fullHunEum:"이제 금",category:"기타"},
{hanja:"太",hun:"클",eum:"태",fullHunEum:"클 태",category:"기타"},
{hanja:"少",hun:"적을",eum:"소",fullHunEum:"적을 소",category:"기타"},
{hanja:"力",hun:"힘",eum:"력",fullHunEum:"힘 력",category:"기타"},
{hanja:"本",hun:"근본",eum:"본",fullHunEum:"근본 본",category:"기타"},
{hanja:"方",hun:"모",eum:"방",fullHunEum:"모 방",category:"기타"},
{hanja:"外",hun:"바깥",eum:"외",fullHunEum:"바깥 외",category:"기타"},
{hanja:"世",hun:"인간",eum:"세",fullHunEum:"인간 세",category:"기타"},
{hanja:"合",hun:"합할",eum:"합",fullHunEum:"합할 합",category:"기타"},
{hanja:"先",hun:"먼저",eum:"선",fullHunEum:"먼저 선",category:"기타"},
{hanja:"立",hun:"설",eum:"립",fullHunEum:"설 립",category:"기타"},
{hanja:"長",hun:"긴",eum:"장",fullHunEum:"긴 장",category:"기타"},
{hanja:"靑",hun:"푸를",eum:"청",fullHunEum:"푸를 청",category:"기타"},
{hanja:"不",hun:"아닐",eum:"불",fullHunEum:"아닐 불",category:"기타"},
{hanja:"入",hun:"들",eum:"입",fullHunEum:"들 입",category:"기타"},
{hanja:"春",hun:"봄",eum:"춘",fullHunEum:"봄 춘",category:"계절"},
{hanja:"夏",hun:"여름",eum:"하",fullHunEum:"여름 하",category:"계절"},
{hanja:"秋",hun:"가을",eum:"추",fullHunEum:"가을 추",category:"계절"},
{hanja:"冬",hun:"겨울",eum:"동",fullHunEum:"겨울 동",category:"계절"},
];

const ALL_HANJA=[...HANJA_CORE,...HANJA_EXTRA];

const ANTONYM_PAIRS=[
["上","下"],["左","右"],["東","西"],["南","北"],
["大","小"],["天","地"],["山","川"],["火","水"],
["父","母"],["兄","弟"],["男","女"],["古","今"],
["春","秋"],["夏","冬"],["出","入"],["外","中"]
];

const IDIOMS=[
{idiom:"山川草木",reading:"산천초목",meaning:"산과 내와 풀과 나무, 자연"},
{idiom:"東西南北",reading:"동서남북",meaning:"모든 방향"},
{idiom:"春夏秋冬",reading:"춘하추동",meaning:"사계절"},
{idiom:"上下左右",reading:"상하좌우",meaning:"위아래와 좌우"},
{idiom:"名山大川",reading:"명산대천",meaning:"이름난 산과 큰 내"}
];

const HANJA_BY_CATEGORY={};
ALL_HANJA.forEach(h=>{
  if(!HANJA_BY_CATEGORY[h.category]) HANJA_BY_CATEGORY[h.category]=[];
  HANJA_BY_CATEGORY[h.category].push(h);
});

const GAME_LIST=[
  {id:'archery',name:'양궁',icon:'🏹',desc:'한자 뜻 맞추기'},
  {id:'swimming',name:'수영',icon:'🏊',desc:'60초 스피드 퀴즈'},
  {id:'weightlifting',name:'역도',icon:'🏋️',desc:'연속 정답 도전'},
  {id:'gymnastics',name:'체조',icon:'🤸',desc:'카드 매칭 게임'},
  {id:'marathon',name:'마라톤',icon:'🏃',desc:'장애물 달리기'},
  {id:'antonym',name:'반의어',icon:'🔄',desc:'반대말 매칭'},
  {id:'idiom',name:'사자성어',icon:'📜',desc:'사자성어 퀴즈'},
  {id:'homonym',name:'동음이의',icon:'🔤',desc:'같은 소리 다른 뜻'},
];

const FLAG_ICONS=['🇰🇷','🏅','⭐','🔥','💎','🌸','🐯','🦅','🐉','🎯','🏆','💪'];

// ============================
// UTILITIES
// ============================
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function seededRandom(seed){let s=seed;return function(){s=(s*16807)%2147483647;return(s-1)/2147483646;};}
function getDateSeed(){const d=new Date();return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();}
function seededShuffle(arr,seed){const a=[...arr];const rng=seededRandom(seed);for(let i=a.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function $(id){return document.getElementById(id);}
function formatTime(ms){const s=Math.floor(ms/1000);const m=Math.floor(s/60);return m>0?`${m}분 ${s%60}초`:`${s}초`;}

// ============================
// STORAGE
// ============================
const Store={
  _getUsers(){try{return JSON.parse(localStorage.getItem('hanjaOlympics_users'))||{};}catch(e){return{};}},
  _setUsers(u){localStorage.setItem('hanjaOlympics_users',JSON.stringify(u));},
  getCurrentUser(){return localStorage.getItem('hanjaOlympics_currentUser')||null;},
  setCurrentUser(name){if(name)localStorage.setItem('hanjaOlympics_currentUser',name);else localStorage.removeItem('hanjaOlympics_currentUser');},
  getUser(name){return this._getUsers()[name]||null;},
  createUser(name,pw,icon){
    const users=this._getUsers();
    if(users[name])return false;
    users[name]={password:pw,icon:icon,medals:{gold:0,silver:0,bronze:0},
      history:[],wrongAnswers:{},encounteredCharacters:[],
      bestScores:{},dailyChallenge:{lastDate:null,streak:0,lastScore:null,lastMedal:null}};
    this._setUsers(users);return true;
  },
  login(name,pw){
    const u=this.getUser(name);
    if(!u||u.password!==pw)return false;
    this.setCurrentUser(name);return true;
  },
  logout(){this.setCurrentUser(null);},
  updateUser(name,fn){
    const users=this._getUsers();
    if(!users[name])return;
    fn(users[name]);
    this._setUsers(users);
  },
  getAllUsers(){return this._getUsers();},
  saveRankSnapshot(snapshot){localStorage.setItem('hanjaOlympics_rankSnapshot',JSON.stringify(snapshot));},
  getRankSnapshot(){try{return JSON.parse(localStorage.getItem('hanjaOlympics_rankSnapshot'))||{};}catch(e){return{};}},
};

// ============================
// SOUND SYSTEM
// ============================
const SoundSystem={
  ctx:null,
  init(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();},
  playSound(type){
    if(!this.ctx)return;
    const now=this.ctx.currentTime;
    const osc=this.ctx.createOscillator();
    const gain=this.ctx.createGain();
    osc.connect(gain);gain.connect(this.ctx.destination);
    switch(type){
      case 'correct':{
        osc.type='sine';osc.frequency.setValueAtTime(523.25,now);
        osc.frequency.linearRampToValueAtTime(659.25,now+0.15);
        gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.3);
        osc.start(now);osc.stop(now+0.3);break;
      }
      case 'wrong':{
        osc.type='square';osc.frequency.setValueAtTime(200,now);
        osc.frequency.linearRampToValueAtTime(150,now+0.3);
        gain.gain.setValueAtTime(0.2,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.3);
        osc.start(now);osc.stop(now+0.3);break;
      }
      case 'medal':{
        const notes=[523.25,659.25,783.99,1046.5];
        notes.forEach((freq,i)=>{
          const o=this.ctx.createOscillator();const g=this.ctx.createGain();
          o.connect(g);g.connect(this.ctx.destination);o.type='sine';
          o.frequency.setValueAtTime(freq,now+i*0.2);
          g.gain.setValueAtTime(0.25,now+i*0.2);
          g.gain.exponentialRampToValueAtTime(0.01,now+i*0.2+0.25);
          o.start(now+i*0.2);o.stop(now+i*0.2+0.25);
        });break;
      }
      case 'flip':{
        osc.type='sine';osc.frequency.setValueAtTime(800,now);
        gain.gain.setValueAtTime(0.15,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.05);
        osc.start(now);osc.stop(now+0.05);break;
      }
      case 'tick':{
        osc.type='sine';osc.frequency.setValueAtTime(1000,now);
        gain.gain.setValueAtTime(0.1,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.05);
        osc.start(now);osc.stop(now+0.05);break;
      }
      case 'impact_light':{
        osc.type='sine';osc.frequency.setValueAtTime(800,now);osc.frequency.exponentialRampToValueAtTime(200,now+0.05);
        gain.gain.setValueAtTime(0.35,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.08);
        osc.start(now);osc.stop(now+0.08);break;
      }
      case 'impact_heavy':{
        osc.type='square';osc.frequency.setValueAtTime(200,now);osc.frequency.exponentialRampToValueAtTime(60,now+0.15);
        gain.gain.setValueAtTime(0.4,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.2);
        osc.start(now);osc.stop(now+0.2);break;
      }
      case 'whoosh':{
        const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.2,this.ctx.sampleRate);
        const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.max(0,1-i/d.length);
        const src=this.ctx.createBufferSource();src.buffer=buf;
        const flt=this.ctx.createBiquadFilter();flt.type='bandpass';flt.frequency.value=2000;flt.Q.value=1;
        const g2=this.ctx.createGain();g2.gain.setValueAtTime(0.25,now);g2.gain.exponentialRampToValueAtTime(0.01,now+0.2);
        src.connect(flt);flt.connect(g2);g2.connect(this.ctx.destination);src.start(now);
        osc.frequency.setValueAtTime(20,now);gain.gain.setValueAtTime(0,now);osc.start(now);osc.stop(now+0.01);break;
      }
      case 'splash_sfx':{
        const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.15,this.ctx.sampleRate);
        const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.max(0,1-i/d.length*2);
        const src=this.ctx.createBufferSource();src.buffer=buf;
        const flt=this.ctx.createBiquadFilter();flt.type='lowpass';flt.frequency.value=1500;
        const g2=this.ctx.createGain();g2.gain.setValueAtTime(0.3,now);g2.gain.exponentialRampToValueAtTime(0.01,now+0.15);
        src.connect(flt);flt.connect(g2);g2.connect(this.ctx.destination);src.start(now);
        osc.frequency.setValueAtTime(20,now);gain.gain.setValueAtTime(0,now);osc.start(now);osc.stop(now+0.01);break;
      }
      case 'metal_clang':{
        osc.type='triangle';osc.frequency.setValueAtTime(440,now);
        gain.gain.setValueAtTime(0.35,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.3);
        const o2=this.ctx.createOscillator();const g2=this.ctx.createGain();
        o2.connect(g2);g2.connect(this.ctx.destination);o2.type='triangle';
        o2.frequency.setValueAtTime(880,now);g2.gain.setValueAtTime(0.15,now);g2.gain.exponentialRampToValueAtTime(0.01,now+0.2);
        o2.start(now);o2.stop(now+0.2);osc.start(now);osc.stop(now+0.3);break;
      }
      case 'countdown_tick':{
        osc.type='sine';osc.frequency.setValueAtTime(440,now);
        gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.12);
        osc.start(now);osc.stop(now+0.12);break;
      }
      case 'countdown_go':{
        [523.25,659.25,783.99].forEach((f,i)=>{
          const o=this.ctx.createOscillator();const g=this.ctx.createGain();
          o.connect(g);g.connect(this.ctx.destination);o.type='sine';
          o.frequency.setValueAtTime(f,now);g.gain.setValueAtTime(0.25,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.35);
          o.start(now);o.stop(now+0.35);
        });
        osc.frequency.setValueAtTime(20,now);gain.gain.setValueAtTime(0,now);osc.start(now);osc.stop(now+0.01);break;
      }
      case 'combo_hit':{
        const freq=600+(this._comboFreq||0)*80;this._comboFreq=(this._comboFreq||0)+1;
        osc.type='sine';osc.frequency.setValueAtTime(freq,now);osc.frequency.linearRampToValueAtTime(freq*1.5,now+0.1);
        gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.15);
        osc.start(now);osc.stop(now+0.15);break;
      }
      case 'power_charge':{
        osc.type='sawtooth';osc.frequency.setValueAtTime(100,now);osc.frequency.linearRampToValueAtTime(800,now+0.3);
        gain.gain.setValueAtTime(0.15,now);gain.gain.linearRampToValueAtTime(0.3,now+0.25);gain.gain.exponentialRampToValueAtTime(0.01,now+0.35);
        osc.start(now);osc.stop(now+0.35);break;
      }
      case 'gauge_stop':{
        osc.type='square';osc.frequency.setValueAtTime(600,now);
        gain.gain.setValueAtTime(0.35,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.06);
        osc.start(now);osc.stop(now+0.06);break;
      }
      case 'cheer':{
        const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.5,this.ctx.sampleRate);
        const d=buf.getChannelData(0);for(let i=0;i<d.length;i++){const t=i/this.ctx.sampleRate;d[i]=(Math.random()*2-1)*Math.max(0,1-t*2)*0.3;}
        const src=this.ctx.createBufferSource();src.buffer=buf;
        const flt=this.ctx.createBiquadFilter();flt.type='bandpass';flt.frequency.value=1200;flt.Q.value=0.5;
        const g2=this.ctx.createGain();g2.gain.setValueAtTime(0.3,now);
        src.connect(flt);flt.connect(g2);g2.connect(this.ctx.destination);src.start(now);
        osc.frequency.setValueAtTime(20,now);gain.gain.setValueAtTime(0,now);osc.start(now);osc.stop(now+0.01);break;
      }
      case 'whistle':{
        osc.type='sine';osc.frequency.setValueAtTime(2000,now);osc.frequency.linearRampToValueAtTime(1500,now+0.15);
        osc.frequency.setValueAtTime(2000,now+0.2);osc.frequency.linearRampToValueAtTime(1500,now+0.4);
        gain.gain.setValueAtTime(0.2,now);gain.gain.setValueAtTime(0.2,now+0.15);gain.gain.exponentialRampToValueAtTime(0.01,now+0.45);
        osc.start(now);osc.stop(now+0.45);break;
      }
      case 'heartbeat':{
        osc.type='sine';osc.frequency.setValueAtTime(60,now);
        gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.15);
        const o2=this.ctx.createOscillator();const g2=this.ctx.createGain();
        o2.connect(g2);g2.connect(this.ctx.destination);o2.type='sine';o2.frequency.setValueAtTime(55,now+0.2);
        g2.gain.setValueAtTime(0.25,now+0.2);g2.gain.exponentialRampToValueAtTime(0.01,now+0.35);
        o2.start(now+0.2);o2.stop(now+0.35);osc.start(now);osc.stop(now+0.15);break;
      }
    }
  },
  resetCombo(){this._comboFreq=0;},
  _loops:{},
  startLoop(id,type,interval){
    this.stopLoop(id);
    const play=()=>this.playSound(type);
    play();this._loops[id]=setInterval(play,interval);
  },
  stopLoop(id){if(this._loops[id]){clearInterval(this._loops[id]);delete this._loops[id];}},
  stopAllLoops(){Object.keys(this._loops).forEach(id=>this.stopLoop(id));}
};
document.addEventListener('click',()=>SoundSystem.init(),{once:true});
document.addEventListener('touchstart',()=>SoundSystem.init(),{once:true});

// ============================
// EFFECTS SYSTEM
// ============================
const Effects={
  shake(level='light'){
    const el=document.querySelector('.app-container');if(!el)return;
    el.classList.remove('shake-light','shake-medium','shake-heavy');
    void el.offsetWidth;
    el.classList.add('shake-'+level);
    if(navigator.vibrate)navigator.vibrate(level==='heavy'?[50,30,80]:level==='medium'?[40,20,40]:[30]);
    setTimeout(()=>el.classList.remove('shake-'+level),level==='heavy'?500:level==='medium'?300:200);
  },
  flash(color='green'){
    let el=document.querySelector('.flash-overlay');
    if(!el){el=document.createElement('div');el.className='flash-overlay';document.body.appendChild(el);}
    el.className='flash-overlay flash-'+color;
    void el.offsetWidth;el.classList.add('active');
    setTimeout(()=>{el.classList.remove('active');},color==='gold'?350:200);
  },
  hitStop(ms=80){
    const el=document.querySelector('.app-container');if(!el)return;
    el.classList.add('hit-stop');setTimeout(()=>el.classList.remove('hit-stop'),ms);
  },
  particles(type,x,y,count=8){
    const colors={sparkle:['#FFD700','#FF6B6B','#00E5FF','#76FF03','#FF4081','#FFEA00'],
      splash_p:['#00B4D8','#48CAE4','#90E0EF','#ADE8F4'],dust_p:['#8D6E63','#A1887F','#BCAAA4'],
      heart_break:['#EE334E','#FF6B6B']};
    const cls=type==='splash_p'?'splash-p':type==='dust_p'?'dust-p':type;
    for(let i=0;i<count;i++){
      const el=document.createElement('div');el.className='particle '+cls;
      const angle=Math.random()*Math.PI*2;const dist=30+Math.random()*50;
      const dx=Math.cos(angle)*dist,dy=Math.sin(angle)*dist;
      el.style.cssText=`left:${x}px;top:${y}px;--dx:${dx}px;--dy:${dy}px;--dx2:${dx*0.7}px;--rot:${Math.random()*360}deg;`;
      if(type==='heart_break'){el.textContent='💔';}
      else{const c=(colors[type]||colors.sparkle);el.style.background=c[Math.floor(Math.random()*c.length)];}
      document.body.appendChild(el);setTimeout(()=>el.remove(),700);
    }
  },
  comboPopup(count,container){
    if(!container)return;
    let el=container.querySelector('.combo-display');
    if(!el){el=document.createElement('div');el.className='combo-display';container.appendChild(el);}
    const tier=count>=5?'ULTRA':count>=3?'SUPER':count>=2?'COMBO':'';
    if(!tier){el.innerHTML='';return;}
    const color=count>=5?'#FFD700':count>=3?'#FF4081':'#00E5FF';
    const size=Math.min(1.5+count*0.15,3);
    el.innerHTML=`<div class="combo-text" style="font-size:${size}rem;color:${color};">${count}x ${tier}!</div>`;
  },
  textPopup(text,color,x,y,container){
    const el=document.createElement('div');el.className='text-popup';
    el.style.cssText=`left:${x}px;top:${y}px;color:${color};font-size:1.4rem;`;
    el.textContent=text;(container||document.body).appendChild(el);
    setTimeout(()=>el.remove(),800);
  },
  countdown(callback){
    const overlay=document.createElement('div');overlay.className='countdown-overlay';
    document.body.appendChild(overlay);
    const steps=['3','2','1','GO!'];
    let i=0;
    const next=()=>{
      if(i>=steps.length){overlay.remove();callback();return;}
      overlay.innerHTML=`<div class="countdown-text ${steps[i]==='GO!'?'go':''}">${steps[i]}</div>`;
      SoundSystem.playSound(steps[i]==='GO!'?'countdown_go':'countdown_tick');
      i++;setTimeout(next,700);
    };
    next();
  },
  vignette(show){
    let el=document.querySelector('.vignette-red');
    if(show&&!el){el=document.createElement('div');el.className='vignette-red';document.body.appendChild(el);}
    if(!show&&el)el.remove();
  },
  clearAll(){
    document.querySelectorAll('.flash-overlay,.particle,.countdown-overlay,.vignette-red,.combo-display,.text-popup,.obstacle-banner').forEach(e=>e.remove());
    SoundSystem.stopAllLoops();
    const el=document.querySelector('.app-container');
    if(el)el.classList.remove('shake-light','shake-medium','shake-heavy','hit-stop');
  }
};

// ============================
// ROUTER
// ============================
let currentEngine=null;
let currentAbort=null;
const Router={
  navigate(screenId){
    if(currentEngine&&currentEngine.cleanup)currentEngine.cleanup();
    currentEngine=null;
    if(currentAbort)currentAbort.abort();
    currentAbort=new AbortController();
    Effects.clearAll();
    document.querySelectorAll('.screen').forEach(s=>{s.classList.remove('active');s.classList.remove('game-screen-active');});
    const target=$(screenId);
    if(target)target.classList.add('active');
    return currentAbort.signal;
  }
};

// ============================
// CONFETTI
// ============================
function spawnConfetti(){
  const colors=['#FFD700','#EE334E','#0081C8','#00A651','#FCB131','#FF69B4'];
  for(let i=0;i<40;i++){
    const el=document.createElement('div');
    el.className='confetti-piece';
    el.style.left=Math.random()*100+'vw';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay=Math.random()*1.5+'s';
    el.style.animationDuration=(2+Math.random()*1.5)+'s';
    el.style.width=(6+Math.random()*8)+'px';
    el.style.height=(6+Math.random()*8)+'px';
    el.style.borderRadius=Math.random()>0.5?'50%':'2px';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),4000);
  }
}

// ============================
// DECOY GENERATION
// ============================
function generateDecoys(correct,pool,count,key){
  // prefer same-eum for fullHunEum key
  const decoys=[];
  const sameEum=pool.filter(h=>h.hanja!==correct.hanja&&h.eum===correct.eum);
  const others=pool.filter(h=>h.hanja!==correct.hanja&&h.eum!==correct.eum);
  const shuffledSame=shuffle(sameEum);
  const shuffledOthers=shuffle(others);
  const candidates=[...shuffledSame,...shuffledOthers];
  const usedVals=new Set();usedVals.add(correct[key]);
  for(const c of candidates){
    if(!usedVals.has(c[key])){
      decoys.push(c);usedVals.add(c[key]);
      if(decoys.length>=count)break;
    }
  }
  // fallback if not enough unique
  if(decoys.length<count){
    for(const c of shuffle(pool)){
      if(c.hanja!==correct.hanja&&!decoys.includes(c)){
        decoys.push(c);
        if(decoys.length>=count)break;
      }
    }
  }
  return decoys;
}

// ============================
// RECORD GAME RESULT
// ============================
function recordGameResult(gameId,score,total,medal,wrongList){
  const username=Store.getCurrentUser();
  if(!username)return;
  // save rank snapshot BEFORE updating
  saveRankSnapshot();
  Store.updateUser(username,u=>{
    // medal
    if(medal)u.medals[medal]=(u.medals[medal]||0)+1;
    // best score
    if(!u.bestScores)u.bestScores={};
    const prev=u.bestScores[gameId];
    if(!prev||score>prev.score){
      u.bestScores[gameId]={score,total,medal,date:Date.now()};
    }
    // history
    if(!u.history)u.history=[];
    u.history.unshift({gameId,score,total,medal,date:Date.now()});
    if(u.history.length>50)u.history=u.history.slice(0,50);
    // wrong answers
    if(!u.wrongAnswers)u.wrongAnswers={};
    if(wrongList){
      wrongList.forEach(h=>{
        u.wrongAnswers[h.hanja]=(u.wrongAnswers[h.hanja]||0)+1;
      });
    }
    // encountered
    if(!u.encounteredCharacters)u.encounteredCharacters=[];
    const enc=new Set(u.encounteredCharacters);
    ALL_HANJA.forEach(h=>{if(!enc.has(h.hanja)){}});
  });
}

function recordEncountered(hanjaChars){
  const username=Store.getCurrentUser();
  if(!username)return;
  Store.updateUser(username,u=>{
    if(!u.encounteredCharacters)u.encounteredCharacters=[];
    const enc=new Set(u.encounteredCharacters);
    hanjaChars.forEach(h=>{enc.add(h);});
    u.encounteredCharacters=[...enc];
  });
}

function saveRankSnapshot(){
  const users=Store.getAllUsers();
  const snapshot={};
  const ranked=Object.entries(users).map(([name,u])=>({
    name,points:(u.medals.gold||0)*3+(u.medals.silver||0)*2+(u.medals.bronze||0)
  })).sort((a,b)=>b.points-a.points);
  ranked.forEach((r,i)=>{snapshot[r.name]=i+1;});
  Store.saveRankSnapshot(snapshot);
}

function getMedalForScore(gameId,score){
  switch(gameId){
    case 'archery':case 'daily':return score>=9?'gold':score>=7?'silver':score>=5?'bronze':null;
    case 'swimming':return score>=20?'gold':score>=15?'silver':score>=10?'bronze':null;
    case 'weightlifting':return score>=15?'gold':score>=10?'silver':score>=5?'bronze':null;
    case 'gymnastics':return score<=12?'gold':score<=16?'silver':score<=20?'bronze':null;
    case 'marathon':return score>=90?'gold':score>=70?'silver':score>=50?'bronze':null;
    case 'antonym':return score>=9?'gold':score>=7?'silver':score>=5?'bronze':null;
    case 'idiom':return score>=80?'gold':score>=60?'silver':score>=40?'bronze':null;
    case 'homonym':return score>=15?'gold':score>=10?'silver':score>=5?'bronze':null;
    default:return null;
  }
}

// ============================
// SPLASH SCREEN
// ============================
function initSplash(){
  // 3D Voxel splash scene
  const canvas=document.getElementById('splash3d');
  if(canvas&&typeof THREE!=='undefined'){
    const w=window.innerWidth,h=window.innerHeight;
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:false});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.setSize(w,h);
    const scene=new THREE.Scene();
    scene.background=new THREE.Color(0x080820);
    scene.fog=new THREE.FogExp2(0x080820,0.015);
    const cam=new THREE.PerspectiveCamera(55,w/h,0.1,200);
    cam.position.set(0,6,14);cam.lookAt(0,3,0);
    scene.add(new THREE.AmbientLight(0x334466,0.5));
    const dL=new THREE.DirectionalLight(0xffeedd,0.8);dL.position.set(5,10,5);scene.add(dL);
    const pL1=new THREE.PointLight(0xFFD700,1,20);pL1.position.set(-3,6,3);scene.add(pL1);
    const pL2=new THREE.PointLight(0x4488ff,1,20);pL2.position.set(3,6,3);scene.add(pL2);
    // stars
    const sGeo=new THREE.BufferGeometry();const sPos=[];
    for(let i=0;i<400;i++)sPos.push((Math.random()-.5)*80,Math.random()*40+5,(Math.random()-.5)*80-10);
    sGeo.setAttribute('position',new THREE.Float32BufferAttribute(sPos,3));
    const stars=new THREE.Points(sGeo,new THREE.PointsMaterial({color:0xffffff,size:0.12,transparent:true,opacity:0.8}));
    scene.add(stars);
    // ground
    const gnd=voxBox(30,0.3,20,0x0a1a0a);gnd.position.set(0,-0.15,0);scene.add(gnd);
    // voxel pagoda
    const pagoda=new THREE.Group();
    const floors=[[4,1.5,4,0x8B4513],[3.5,0.3,3.5,0xA0522D],[3,1.2,3,0x8B4513],[2.5,0.3,2.5,0xA0522D],[2,1,2,0x8B4513],[1.5,0.3,1.5,0xA0522D],[1,0.8,1,0x8B4513]];
    let py=0;
    floors.forEach(([fw,fh,fd,fc])=>{
      const f=voxBox(fw,fh,fd,fc);f.position.y=py+fh/2;pagoda.add(f);
      py+=fh;
    });
    // roof tip
    const tip=new THREE.Mesh(new THREE.ConeGeometry(0.3,1,4),new THREE.MeshLambertMaterial({color:0xFFD700}));
    tip.position.y=py+0.5;pagoda.add(tip);
    pagoda.position.set(0,0,0);scene.add(pagoda);
    // lanterns
    const lanterns=[];
    [[-3,3,3],[3,3,3],[-2,5,-2],[2,5,-2]].forEach(([lx,ly,lz])=>{
      const lg=new THREE.Group();
      const lb=voxBox(0.4,0.5,0.4,0xEE334E);lg.add(lb);
      const ll=new THREE.PointLight(0xff6622,0.8,8);ll.position.y=0;lg.add(ll);
      lg.position.set(lx,ly,lz);scene.add(lg);lanterns.push({g:lg,l:ll,baseY:ly});
    });
    // floating hanja characters
    const floatChars=[];
    const sample=shuffle(ALL_HANJA).slice(0,8);
    sample.forEach((h,i)=>{
      const tex=makeTextCanvas(h.hanja,120,'#FFD700','rgba(0,0,0,0)');
      const mat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:0.6});
      const sp=new THREE.Sprite(mat);sp.scale.set(1.2,1.2,1);
      const angle=i/8*Math.PI*2;
      sp.position.set(Math.cos(angle)*6,2+Math.random()*3,Math.sin(angle)*6);
      scene.add(sp);floatChars.push({sp,angle,baseY:sp.position.y,speed:0.3+Math.random()*0.3});
    });
    // olympic ring particles
    const ringCols=[0x0081C8,0xFCB131,0x000000,0x00A651,0xEE334E];
    ringCols.forEach((c,i)=>{
      for(let j=0;j<3;j++){
        const p=voxBox(0.15,0.15,0.15,c);
        p.position.set(-2+i*1,7+Math.random(),Math.random()*2);
        p.userData={vy:1+Math.random(),phase:Math.random()*6};
        scene.add(p);
      }
    });
    // animate
    let t=0;
    function animate(){
      t+=0.016;
      pagoda.rotation.y+=0.003;
      stars.rotation.y+=0.0005;
      // lanterns bob
      lanterns.forEach((l,i)=>{l.g.position.y=l.baseY+Math.sin(t*2+i)*0.2;l.l.intensity=0.6+Math.sin(t*3+i*2)*0.3;});
      // floating chars orbit
      floatChars.forEach(f=>{
        f.angle+=f.speed*0.016;
        f.sp.position.x=Math.cos(f.angle)*6;
        f.sp.position.z=Math.sin(f.angle)*6;
        f.sp.position.y=f.baseY+Math.sin(t*1.5+f.angle)*0.5;
      });
      renderer.render(scene,cam);
      if(document.getElementById('screen-splash')&&document.getElementById('screen-splash').classList.contains('active')){
        requestAnimationFrame(animate);
      }else{
        renderer.dispose();
      }
    }
    animate();
  }
  // transition
  setTimeout(()=>{
    const ld=document.getElementById('splash-loading');
    if(ld)ld.textContent='';
    const cu=Store.getCurrentUser();
    if(cu&&Store.getUser(cu)){
      showHub();
    }else{
      showAuth();
    }
  },2500);
}

// ============================
// AUTH SCREEN
// ============================
function showAuth(){
  const signal=Router.navigate('screen-auth');
  let mode='login';
  renderAuthForm(mode,signal);
  $('auth-tabs').querySelectorAll('.auth-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      mode=tab.dataset.tab;
      $('auth-tabs').querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      renderAuthForm(mode,signal);
    },{signal});
  });
}

function renderAuthForm(mode,signal){
  const form=$('auth-form');
  $('auth-error').textContent='';
  if(mode==='login'){
    form.innerHTML=`
      <div class="input-group"><label>닉네임</label><input type="text" id="auth-name" maxlength="8" autocomplete="username"></div>
      <div class="input-group"><label>비밀번호</label><input type="password" id="auth-pw" autocomplete="current-password"></div>
      <button class="btn-primary" id="auth-submit">로그인</button>
    `;
  }else{
    form.innerHTML=`
      <div class="input-group"><label>닉네임 (2~8자)</label><input type="text" id="auth-name" maxlength="8" autocomplete="username"></div>
      <div class="input-group"><label>비밀번호 (4자 이상)</label><input type="password" id="auth-pw" autocomplete="new-password"></div>
      <div class="input-group"><label>아이콘 선택</label>
        <div class="icon-picker" id="auth-icons">${FLAG_ICONS.map(ic=>`<div class="icon-option" data-icon="${ic}">${ic}</div>`).join('')}</div>
      </div>
      <button class="btn-primary" id="auth-submit">회원가입</button>
    `;
    let selectedIcon=FLAG_ICONS[0];
    const iconEls=$('auth-icons').querySelectorAll('.icon-option');
    iconEls[0].classList.add('selected');
    iconEls.forEach(el=>{
      el.addEventListener('click',()=>{
        iconEls.forEach(e=>e.classList.remove('selected'));
        el.classList.add('selected');
        selectedIcon=el.dataset.icon;
      },{signal});
    });
    // store getter
    form._getIcon=()=>selectedIcon;
  }
  $('auth-submit').addEventListener('click',()=>{
    const name=$('auth-name').value.trim();
    const pw=$('auth-pw').value;
    if(mode==='login'){
      if(!name||!pw){$('auth-error').textContent='닉네임과 비밀번호를 입력하세요';return;}
      if(Store.login(name,pw)){showHub();}
      else{$('auth-error').textContent='닉네임 또는 비밀번호가 올바르지 않습니다';}
    }else{
      if(name.length<2||name.length>8){$('auth-error').textContent='닉네임은 2~8자로 입력하세요';return;}
      if(pw.length<4){$('auth-error').textContent='비밀번호는 4자 이상이어야 합니다';return;}
      const icon=form._getIcon?form._getIcon():FLAG_ICONS[0];
      if(!Store.createUser(name,pw,icon)){$('auth-error').textContent='이미 사용 중인 닉네임입니다';return;}
      Store.setCurrentUser(name);showHub();
    }
  },{signal});
}

// ============================
// HUB SCREEN
// ============================
function showHub(){
  const signal=Router.navigate('screen-hub');
  const username=Store.getCurrentUser();
  const user=Store.getUser(username);
  if(!user){showAuth();return;}
  $('hub-user-icon').textContent=user.icon;
  $('hub-user-name').textContent=username;

  // Daily card
  const dailyDiv=$('hub-daily-card');
  const todayStr=new Date().toISOString().slice(0,10);
  const dc=user.dailyChallenge||{};
  const doneToday=dc.lastDate===todayStr;
  dailyDiv.innerHTML=`<div class="daily-card" id="hub-daily-btn">
    <div class="daily-card-title">일일 도전 ${doneToday?'(완료)':''}</div>
    <div class="daily-card-info">${doneToday?`오늘 점수: ${dc.lastScore}/10 ${dc.lastMedal?medalEmoji(dc.lastMedal):''}`:'오늘의 한자 도전에 참여하세요!'}</div>
    ${dc.streak?`<div class="daily-streak">연속 ${dc.streak}일</div>`:''}
  </div>`;
  $('hub-daily-btn').addEventListener('click',()=>startDaily(),{signal});

  // Game grid
  const grid=$('hub-game-grid');
  grid.innerHTML='';
  GAME_LIST.forEach(g=>{
    const best=user.bestScores&&user.bestScores[g.id];
    const div=document.createElement('div');
    div.className='game-card anim-fadeIn';
    div.innerHTML=`
      <div class="game-card-icon">${g.icon}</div>
      <div class="game-card-name">${g.name}</div>
      <div class="game-card-best">${best?`최고: ${best.score}${g.id==='gymnastics'?'회':'점'} ${best.medal?medalEmoji(best.medal):''}`:'도전하기'}</div>
    `;
    div.addEventListener('click',()=>startGame(g.id),{signal});
    grid.appendChild(div);
  });

  $('hub-btn-leaderboard').addEventListener('click',()=>showLeaderboard(),{signal});
  $('hub-btn-profile').addEventListener('click',()=>showProfile(),{signal});
  $('hub-btn-study').addEventListener('click',()=>showStudy(),{signal});
}

function medalEmoji(m){return m==='gold'?'🥇':m==='silver'?'🥈':m==='bronze'?'🥉':'';}

// --- DAILY ---
function createDailyEngine(){
  let questions=[],current=0,score=0,wrongList=[],encountered=[],container,signal;
  return{
    init(c,s){container=c;signal=s;},
    start(){
      const todayStr=new Date().toISOString().slice(0,10);
      const username=Store.getCurrentUser();
      const user=Store.getUser(username);
      const dc=user.dailyChallenge||{};
      if(dc.lastDate===todayStr){
        this._showDone(dc);return;
      }
      const seed=getDateSeed();
      questions=seededShuffle(ALL_HANJA,seed).slice(0,10);
      current=0;score=0;wrongList=[];encountered=[];
      this._render();
    },
    _showDone(dc){
      container.innerHTML=`
        <div class="game-header">
          <button class="game-back" id="g-back">&#8592;</button>
          <span class="game-title">일일 도전</span>
          <span style="width:44px"></span>
        </div>
        <div class="daily-done">
          <div class="daily-done-medal">${dc.lastMedal?medalEmoji(dc.lastMedal):'🎯'}</div>
          <div class="title-md">오늘의 도전 완료!</div>
          <div style="font-size:1.2rem;margin:8px 0;">점수: ${dc.lastScore}/10</div>
          ${dc.streak?`<div style="color:var(--blue);font-weight:600;">연속 ${dc.streak}일 도전 중</div>`:''}
          <div class="daily-countdown" id="daily-countdown"></div>
        </div>
      `;
      $('g-back').addEventListener('click',()=>showHub(),{signal});
      this._updateCountdown();
    },
    _updateCountdown(){
      const updateFn=()=>{
        const now=new Date();
        const tomorrow=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1);
        const diff=tomorrow-now;
        const h=Math.floor(diff/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        const el=$('daily-countdown');
        if(el)el.textContent=`다음 도전까지 ${h}시간 ${m}분 ${s}초`;
      };
      updateFn();
      const intv=setInterval(updateFn,1000);
      // auto-clear via signal
      if(signal){signal.addEventListener('abort',()=>clearInterval(intv));}
    },
    _render(){
      if(current>=questions.length){this._finish();return;}
      const q=questions[current];
      encountered.push(q.hanja);
      const decoys=generateDecoys(q,ALL_HANJA,3,'fullHunEum');
      const options=shuffle([q,...decoys]);
      container.innerHTML=`
        <div class="game-header">
          <button class="game-back" id="g-back">&#8592;</button>
          <span class="game-title">일일 도전</span>
          <span class="game-info">${current+1}/10</span>
        </div>
        <div class="game-progress"><div class="game-progress-bar" style="width:${current/10*100}%"></div></div>
        <div class="game-question">
          <div style="font-size:.9rem;color:#888;margin-bottom:8px;">이 한자의 훈음은?</div>
          <div class="hanja-display anim-bounceIn">${q.hanja}</div>
        </div>
        <div class="game-options" id="g-opts">
          ${options.map(o=>`<button class="game-option" data-val="${o.fullHunEum}">${o.fullHunEum}</button>`).join('')}
        </div>
      `;
      $('g-back').addEventListener('click',()=>showHub(),{signal});
      container.querySelectorAll('#g-opts .game-option').forEach(btn=>{
        btn.addEventListener('click',()=>this._answer(btn,q),{signal});
      });
    },
    _answer(btn,q){
      const all=container.querySelectorAll('#g-opts .game-option');
      all.forEach(b=>b.classList.add('disabled'));
      if(btn.dataset.val===q.fullHunEum){
        btn.classList.add('correct');score++;SoundSystem.playSound('correct');
        Effects.flash('green');Effects.shake('light');
      }else{
        btn.classList.add('wrong');wrongList.push(q);SoundSystem.playSound('wrong');
        Effects.flash('red');Effects.shake('medium');
        all.forEach(b=>{if(b.dataset.val===q.fullHunEum)b.classList.add('correct');});
      }
      setTimeout(()=>{current++;this._render();},600);
    },
    _finish(){
      recordEncountered(encountered);
      const medal=getMedalForScore('daily',score);
      recordGameResult('daily',score,10,medal,wrongList);
      // update daily challenge
      const todayStr=new Date().toISOString().slice(0,10);
      const username=Store.getCurrentUser();
      Store.updateUser(username,u=>{
        if(!u.dailyChallenge)u.dailyChallenge={};
        const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);
        const yStr=yesterday.toISOString().slice(0,10);
        if(u.dailyChallenge.lastDate===yStr){
          u.dailyChallenge.streak=(u.dailyChallenge.streak||0)+1;
        }else if(u.dailyChallenge.lastDate!==todayStr){
          u.dailyChallenge.streak=1;
        }
        u.dailyChallenge.lastDate=todayStr;
        u.dailyChallenge.lastScore=score;
        u.dailyChallenge.lastMedal=medal;
      });
      showResult('daily','일일 도전',score,10,medal,`${score}/10 정답`);
    },
    cleanup(){},
    getResult(){return{score};}
  };
}











// ============================
// START GAME
// ============================

// ============================
// 3D GAME ENGINE (Three.js)
// ============================
const GE3D={
  container:null,ui:null,renderer:null,game:null,running:false,lastT:0,
  shakeIntensity:0,shakeDuration:0,shakeTime:0,shakeOffset:{x:0,y:0,z:0},
  particles3d:[],
  init(){
    this.container=document.getElementById('game3d');
    this.ui=document.getElementById('game3d-ui');
    if(!this.renderer){
      this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
      this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
      this.renderer.shadowMap.enabled=true;
      this.renderer.shadowMap.type=THREE.PCFSoftShadowMap;
      this.container.insertBefore(this.renderer.domElement,this.container.firstChild);
    }
    this._rsz();
    window.addEventListener('resize',()=>this._rsz());
  },
  _rsz(){
    const w=window.innerWidth,h=window.innerHeight;
    this.renderer.setSize(w,h);
    if(this.game&&this.game.camera){
      this.game.camera.aspect=w/h;
      this.game.camera.updateProjectionMatrix();
    }
  },
  start(g){
    this.game=g;this.running=true;this.particles3d=[];
    this.container.style.display='block';this.lastT=performance.now();
    this._loop();
  },
  stop(){
    this.running=false;this.container.style.display='none';
    if(this.game&&this.game.cleanup)this.game.cleanup();
    this.game=null;this.ui.innerHTML='';
    this.particles3d.forEach(p=>{if(p.parent)p.parent.remove(p);});
    this.particles3d=[];
  },
  _loop(){
    if(!this.running)return;
    const now=performance.now(),dt=Math.min((now-this.lastT)/1000,0.05);this.lastT=now;
    // shake
    if(this.shakeDuration>0){
      this.shakeTime+=dt;
      if(this.shakeTime<this.shakeDuration){
        const p=1-this.shakeTime/this.shakeDuration;
        this.shakeOffset.x=(Math.random()-0.5)*2*this.shakeIntensity*p;
        this.shakeOffset.y=(Math.random()-0.5)*2*this.shakeIntensity*p;
      }else{this.shakeOffset.x=0;this.shakeOffset.y=0;this.shakeDuration=0;}
    }
    if(this.game){
      this.game.update(dt);
      if(this.game.camera){
        this.game.camera.position.x+=this.shakeOffset.x*0.1;
        this.game.camera.position.y+=this.shakeOffset.y*0.1;
      }
      // update 3d particles
      this.particles3d=this.particles3d.filter(p=>{
        p.life-=dt;p.position.x+=p.vx*dt;p.position.y+=p.vy*dt;p.position.z+=p.vz*dt;
        p.vy-=9.8*dt;p.rotation.x+=dt*3;p.rotation.z+=dt*2;
        const s=Math.max(0,p.life/p.maxLife);p.scale.setScalar(s*p.baseScale);
        if(p.life<=0){if(p.parent)p.parent.remove(p);return false;}
        return true;
      });
      this.renderer.render(this.game.scene,this.game.camera);
      // restore camera
      if(this.game.camera){
        this.game.camera.position.x-=this.shakeOffset.x*0.1;
        this.game.camera.position.y-=this.shakeOffset.y*0.1;
      }
    }
    requestAnimationFrame(()=>this._loop());
  },
  shake(intensity,duration){this.shakeIntensity=intensity;this.shakeDuration=duration;this.shakeTime=0;},
  burst3d(scene,x,y,z,color,count,speed,life){
    const geo=new THREE.BoxGeometry(0.15,0.15,0.15);
    const mat=new THREE.MeshLambertMaterial({color});
    for(let i=0;i<count;i++){
      const m=new THREE.Mesh(geo,mat.clone());
      m.position.set(x,y,z);
      const a=Math.random()*Math.PI*2,e=Math.random()*Math.PI-Math.PI/2;
      const s=speed*(0.5+Math.random()*0.5);
      m.vx=Math.cos(a)*Math.cos(e)*s;m.vy=Math.sin(e)*s+speed*0.5;m.vz=Math.sin(a)*Math.cos(e)*s;
      m.life=life*(0.5+Math.random()*0.5);m.maxLife=m.life;m.baseScale=0.5+Math.random()*1;
      scene.add(m);this.particles3d.push(m);
    }
  },
  setUI(html){this.ui.innerHTML=html;this.ui.querySelectorAll('.g3d-btn').forEach(b=>{b.style.pointerEvents='auto';});},
};

// ============================
// VOXEL HELPERS
// ============================
function voxBox(w,h,d,color){
  return new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshLambertMaterial({color}));
}
function voxBoxPhong(w,h,d,color,emissive){
  return new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color,emissive:emissive||0x000000,shininess:30}));
}
function makeVoxelChar(color,headColor){
  const g=new THREE.Group();
  const body=voxBox(0.6,0.8,0.4,color);body.position.y=0.4;g.add(body);
  const head=voxBox(0.5,0.5,0.5,headColor||0xFFDDB0);head.position.y=1.05;g.add(head);
  const lArm=voxBox(0.2,0.6,0.2,color);lArm.position.set(-0.5,0.5,0);g.add(lArm);
  const rArm=voxBox(0.2,0.6,0.2,color);rArm.position.set(0.5,0.5,0);g.add(rArm);
  const lLeg=voxBox(0.25,0.5,0.25,0x333366);lLeg.position.set(-0.15,-0.15,0);g.add(lLeg);
  const rLeg=voxBox(0.25,0.5,0.25,0x333366);rLeg.position.set(0.15,-0.15,0);g.add(rLeg);
  return g;
}
function makeVoxelTree(x,z,scale){
  const g=new THREE.Group();
  const trunk=voxBox(0.3*scale,1.2*scale,0.3*scale,0x8B4513);trunk.position.y=0.6*scale;g.add(trunk);
  const top=voxBox(1*scale,1*scale,1*scale,0x228B22);top.position.y=1.5*scale;g.add(top);
  const top2=voxBox(0.7*scale,0.7*scale,0.7*scale,0x2E8B57);top2.position.y=2.1*scale;g.add(top2);
  g.position.set(x,0,z);return g;
}


function makeTextCanvas(text,fontSize,color,bgColor,cw,ch){
  const canvas=document.createElement('canvas');canvas.width=cw||256;canvas.height=ch||256;
  const ctx=canvas.getContext('2d');
  if(bgColor){ctx.fillStyle=bgColor;ctx.fillRect(0,0,canvas.width,canvas.height);}
  ctx.fillStyle=color||'#fff';
  ctx.font=`bold ${fontSize||80}px "Noto Sans KR",serif`;
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(text,canvas.width/2,canvas.height/2);
  return new THREE.CanvasTexture(canvas);
}
function makeTextSprite(text,scale,color,bgColor){
  const tex=makeTextCanvas(text,100,color||'#fff',bgColor||'rgba(0,0,0,0)');
  const mat=new THREE.SpriteMaterial({map:tex,transparent:true});
  const sprite=new THREE.Sprite(mat);sprite.scale.set(scale||1,scale||1,1);return sprite;
}
function project3Dto2D(pos,cam){
  const v=pos.clone().project(cam);
  return{x:(v.x*0.5+0.5)*window.innerWidth,y:(-v.y*0.5+0.5)*window.innerHeight};
}
// ============================
// HUD / UI HELPERS
// ============================
function g3dHUD(left,center,right){
  return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;pointer-events:auto;">
    <div style="display:flex;gap:8px;align-items:center;">${left}</div>
    <div style="font-weight:800;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.5);font-size:.95rem;">${center}</div>
    <div style="display:flex;gap:8px;align-items:center;">${right}</div>
  </div>`;
}
function g3dBackBtn(){
  return `<button class="g3d-btn" onclick="GE3D.stop();showHub();" style="width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,.5);color:#fff;font-size:1.2rem;display:flex;align-items:center;justify-content:center;border:none;backdrop-filter:blur(4px);cursor:pointer;pointer-events:auto;">&#8592;</button>`;
}
function g3dBadge(text,color){
  return `<span style="background:${color||'rgba(0,0,0,.5)'};color:#fff;font-weight:800;font-size:.85rem;padding:4px 12px;border-radius:12px;text-shadow:0 1px 2px rgba(0,0,0,.5);">${text}</span>`;
}
function g3dProgress(pct,color){
  return `<div style="position:absolute;top:0;left:0;right:0;height:4px;background:rgba(255,255,255,.15);">
    <div style="height:100%;width:${pct}%;background:${color||'#76FF03'};transition:width .3s;border-radius:0 2px 2px 0;"></div></div>`;
}
function g3dAnswerGrid(opts,onClickFn,isHanja){
  return `<div style="position:absolute;bottom:0;left:0;right:0;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;pointer-events:auto;">
    ${opts.map((o,i)=>`<button class="g3d-btn g3d-ans" data-idx="${i}" onclick="${onClickFn}(${i})"
      style="padding:${isHanja?'14px 8px':'18px 10px'};border-radius:16px;font-size:${isHanja?'clamp(28px,7vw,44px)':'1.1rem'};font-weight:800;
      border:2px solid rgba(255,255,255,.2);color:#fff;text-align:center;
      background:rgba(255,255,255,.12);backdrop-filter:blur(8px);min-height:56px;
      cursor:pointer;transition:all .15s;text-shadow:0 1px 3px rgba(0,0,0,.4);
      font-family:inherit;">${o.label}</button>`).join('')}
  </div>`;
}
function g3dCountdown(n){
  return `<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;">
    <div style="font-size:6rem;font-weight:900;color:#FFD700;text-shadow:0 0 40px rgba(255,215,0,.8);">${n>0?n:'GO!'}</div></div>`;
}
function markAnswer(idx,correctIdx){
  const btns=document.querySelectorAll('.g3d-ans');
  btns.forEach((b,i)=>{
    b.style.pointerEvents='none';
    if(i===correctIdx){b.style.background='rgba(0,200,80,.7)';b.style.borderColor='#00A651';}
    else if(i===idx&&i!==correctIdx){b.style.background='rgba(238,51,78,.7)';b.style.borderColor='#EE334E';}
    else{b.style.opacity='.5';}
  });
}

// ============================
// ARCHERY - 3D TARGET SHOOTER
// ============================
function createArcheryGame3D(){
  let scene,camera,qs,cur,score,bonus,wrong,enc,phase,targets3d,arrow3d,arrowT;
  let countdown,cdT,starField;
  const targetData=[];
  function reset(){
    qs=shuffle(ALL_HANJA).slice(0,10);cur=0;score=0;bonus=0;wrong=[];enc=[];
    phase='countdown';countdown=3;cdT=0;
    // build scene
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x080820);
    scene.fog=new THREE.FogExp2(0x080820,0.02);
    camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,0.1,200);
    camera.position.set(0,3,10);camera.lookAt(0,2,0);
    // lights
    scene.add(new THREE.AmbientLight(0x334466,0.5));
    const dL=new THREE.DirectionalLight(0xffeedd,0.8);dL.position.set(5,10,5);scene.add(dL);
    const pL=new THREE.PointLight(0x4488ff,0.5,30);pL.position.set(0,5,0);scene.add(pL);
    // stars
    const sGeo=new THREE.BufferGeometry();const sPos=[];
    for(let i=0;i<500;i++)sPos.push((Math.random()-.5)*100,Math.random()*50,(Math.random()-.5)*100-20);
    sGeo.setAttribute('position',new THREE.Float32BufferAttribute(sPos,3));
    starField=new THREE.Points(sGeo,new THREE.PointsMaterial({color:0xffffff,size:0.15,transparent:true,opacity:0.8}));
    scene.add(starField);
    // ground (dark field)
    const gnd=voxBox(40,0.3,30,0x0a1a0a);gnd.position.set(0,-0.5,-5);scene.add(gnd);
    // pillars decoration
    for(let i=-3;i<=3;i+=2){
      const p=voxBox(0.3,4,0.3,0x334455);p.position.set(i*2,2,-5);scene.add(p);
      const top=voxBox(0.5,0.3,0.5,0x4488aa);top.position.set(i*2,4,-5);scene.add(top);
    }
    // bow stand
    const bowBase=voxBox(1,0.3,0.5,0x8B4513);bowBase.position.set(0,0,7);scene.add(bowBase);
    const bowArm=voxBox(0.1,2,0.1,0x654321);bowArm.position.set(0,1,7);scene.add(bowArm);
    setupQ();
  }
  function setupQ(){
    // clear old targets
    targetData.length=0;
    if(targets3d){targets3d.forEach(t=>scene.remove(t.group));}
    targets3d=[];
    if(cur>=qs.length){phase='done';return;}
    const q=qs[cur];enc.push(q.hanja);
    const d=generateDecoys(q,ALL_HANJA,3,'fullHunEum');
    const opts=shuffle([q,...d]);
    const positions=[[-2.5,3.5,-3],[2.5,3.5,-3],[-2.5,1.5,-3],[2.5,1.5,-3]];
    opts.forEach((o,i)=>{
      const [px,py,pz]=positions[i];
      const grp=new THREE.Group();
      // target rings (concentric boxes)
      const r4=voxBox(1.4,1.4,0.15,0xffffff);grp.add(r4);
      const r3=voxBox(1.1,1.1,0.2,0x0081C8);grp.add(r3);
      const r2=voxBox(0.8,0.8,0.25,0xEE334E);grp.add(r2);
      const r1=voxBox(0.5,0.5,0.3,0xFFD700);grp.add(r1);
      grp.position.set(px,py,pz);scene.add(grp);
      const data={group:grp,label:o.fullHunEum,correct:o.fullHunEum===q.fullHunEum,
        bobPhase:Math.random()*Math.PI*2,baseY:py,hit:false};
      targets3d.push(data);targetData.push(data);
    });
    arrow3d=null;arrowT=0;
    if(phase!=='countdown')phase='aim';
    updateUI();
  }
  function updateUI(){
    let h='';
    h+=g3dProgress(cur/10*100,'#76FF03');
    h+=g3dHUD(g3dBackBtn(),cur<qs.length?`<span style="font-size:.75rem;color:rgba(255,255,255,.5);">훈음을 맞추세요</span>`:'',
      g3dBadge((cur<qs.length?cur+1:10)+'/10','rgba(0,0,0,.5)')+' '+g3dBadge(score+(bonus>0?'+'+bonus:'')+'pts','rgba(255,165,0,.5)'));
    // question hanja
    if(cur<qs.length){
      h+=`<div style="text-align:center;margin-top:8px;pointer-events:none;">
        <div style="font-size:3.5rem;font-weight:900;color:rgba(255,255,255,.9);text-shadow:0 0 20px rgba(255,215,0,.3);">${qs[cur].hanja}</div>
        <div style="font-size:.8rem;color:rgba(255,255,255,.4);margin-top:4px;">정답 타겟을 탭하세요</div></div>`;
    }
    // target labels (floating)
    if(targets3d&&phase==='aim'){
      h+=`<div style="position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:8px;pointer-events:auto;">`;
      targets3d.forEach((t,i)=>{
        h+=`<button class="g3d-btn" onclick="window._archeryTap(${i})" style="padding:10px 14px;border-radius:12px;font-size:.9rem;font-weight:700;
          background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);color:#fff;cursor:pointer;backdrop-filter:blur(4px);
          min-width:70px;text-shadow:0 1px 2px rgba(0,0,0,.4);">${t.label}</button>`;
      });
      h+=`</div>`;
    }
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._archeryTap=function(idx){
    if(phase!=='aim')return;
    const t=targets3d[idx];if(!t||t.hit)return;
    t.hit=true;phase='flying';
    SoundSystem.playSound('whoosh');
    // create arrow
    const ag=new THREE.Group();
    const shaft=voxBox(0.08,0.08,1.5,0xdddddd);ag.add(shaft);
    const tip=new THREE.Mesh(new THREE.ConeGeometry(0.1,0.3,4),new THREE.MeshLambertMaterial({color:0xEE334E}));
    tip.rotation.x=Math.PI/2;tip.position.z=-0.9;ag.add(tip);
    ag.position.set(0,1,7);scene.add(ag);
    arrow3d={mesh:ag,target:t.group.position.clone(),startPos:new THREE.Vector3(0,1,7)};arrowT=0;
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='aim';SoundSystem.playSound('countdown_go');}updateUI();}}
      // bob targets
      if(targets3d)targets3d.forEach(t=>{if(!t.hit){t.bobPhase+=dt*1.5;t.group.position.y=t.baseY+Math.sin(t.bobPhase)*0.3;t.group.rotation.y+=dt*0.3;}});
      // rotate stars slowly
      if(starField)starField.rotation.y+=dt*0.01;
      // arrow flight
      if(arrow3d&&phase==='flying'){
        arrowT+=dt*2;const p=Math.min(arrowT,1);
        arrow3d.mesh.position.lerpVectors(arrow3d.startPos,arrow3d.target,p);
        arrow3d.mesh.position.y+=Math.sin(p*Math.PI)*1.5;
        arrow3d.mesh.lookAt(arrow3d.target);
        if(arrowT>=1){
          scene.remove(arrow3d.mesh);
          const t=targets3d.find(t=>t.hit);
          if(t){
            if(t.correct){
              score++;const dist=arrowT;
              let bp=0,label='HIT';
              if(dist<1.05){bp=3;label='PERFECT!';}else if(dist<1.1){bp=2;label='GREAT!';}else{bp=1;label='GOOD';}
              bonus+=bp;
              GE3D.shake(bp>=3?2:bp>=2?1.5:1,bp>=3?0.4:0.3);
              GE3D.burst3d(scene,t.group.position.x,t.group.position.y,t.group.position.z,
                bp>=3?0xFFD700:bp>=2?0x00E5FF:0x00FF00,bp>=3?25:15,bp>=3?5:3,0.8);
              SoundSystem.playSound(bp>=2?'impact_heavy':'impact_light');SoundSystem.playSound('correct');
              // flash target gold
              t.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0x00FF00,emissive:0x00FF00,emissiveIntensity:0.5});});
            }else{
              wrong.push(qs[cur]);
              GE3D.shake(2,0.3);SoundSystem.playSound('wrong');SoundSystem.playSound('impact_heavy');
              GE3D.burst3d(scene,t.group.position.x,t.group.position.y,t.group.position.z,0xEE334E,12,3,0.5);
              t.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0xEE334E,emissive:0xEE334E,emissiveIntensity:0.3});});
              targets3d.filter(t2=>t2.correct).forEach(t2=>{t2.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0x00FF00,emissive:0x00FF00,emissiveIntensity:0.3});});});
            }
          }
          phase='wait';arrow3d=null;updateUI();
          setTimeout(()=>{cur++;setupQ();},900);
        }
      }
    },
    onTap(x,y){},
    getResult(){
      recordEncountered(enc);const m=getMedalForScore('archery',score);
      recordGameResult('archery',score,10,m,wrong);
      return{gameId:'archery',name:'양궁',score,total:10,medal:m,detail:score+'/10 적중 (보너스 +'+bonus+')'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// SWIMMING - 3D POOL RACE
// ============================
function createSwimmingGame3D(){
  let scene,camera,score,wrong,enc,timeLeft,curQ,answered,phase,countdown,cdT;
  let pPos,cpuPos,cpuNames=['AI-김','AI-박','AI-이'],streak,cpuBase;
  let swimmers3d,waterMesh,waterPhase;
  function reset(){
    score=0;wrong=[];enc=[];timeLeft=60;phase='countdown';countdown=3;cdT=0;
    pPos=5;cpuPos=[5,5,5];streak=0;cpuBase=1.0;waterPhase=0;answered=false;
    // build scene
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x003459);
    scene.fog=new THREE.Fog(0x003459,15,40);
    camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,8,12);camera.lookAt(5,0,0);
    // lights
    scene.add(new THREE.AmbientLight(0x4488cc,0.6));
    const dL=new THREE.DirectionalLight(0xffffff,0.7);dL.position.set(5,10,5);scene.add(dL);
    const pL1=new THREE.PointLight(0x00aaff,0.8,20);pL1.position.set(0,3,0);scene.add(pL1);
    // water surface (animated)
    const wGeo=new THREE.PlaneGeometry(30,10,30,30);
    const wMat=new THREE.MeshPhongMaterial({color:0x0077B6,transparent:true,opacity:0.7,shininess:100,specular:0x4488ff});
    waterMesh=new THREE.Mesh(wGeo,wMat);waterMesh.rotation.x=-Math.PI/2;waterMesh.position.set(5,0,0);
    scene.add(waterMesh);
    // pool edges
    const edge1=voxBox(30,0.8,0.5,0xcccccc);edge1.position.set(5,0.2,-5);scene.add(edge1);
    const edge2=voxBox(30,0.8,0.5,0xcccccc);edge2.position.set(5,0.2,5);scene.add(edge2);
    // lane dividers
    for(let i=-1;i<=2;i++){
      for(let x=-5;x<20;x+=1.5){
        const buoy=new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8),new THREE.MeshLambertMaterial({color:i%2===0?0xEE334E:0xFFD700}));
        buoy.position.set(x,0.15,i*2.5-1.25);scene.add(buoy);
      }
    }
    // finish line
    for(let i=0;i<8;i++){
      const fl=voxBox(0.3,0.5,1.25,i%2===0?0x000000:0xffffff);
      fl.position.set(15,0.3,i*1.25-4.375+0.625);scene.add(fl);
    }
    // swimmers (voxel characters in lanes)
    swimmers3d=[];
    const colors=[0x0081C8,0xEE334E,0x00A651,0xFCB131];
    const laneZ=[-3.75,-1.25,1.25,3.75];
    for(let i=0;i<4;i++){
      const s=makeVoxelChar(colors[i],0xFFDDB0);
      s.rotation.y=Math.PI/2;s.scale.setScalar(0.6);
      s.position.set(-5,0.3,laneZ[i]);scene.add(s);
      swimmers3d.push(s);
    }
    nextQ();
  }
  function nextQ(){
    const q=ALL_HANJA[Math.floor(Math.random()*ALL_HANJA.length)];
    curQ={...q};answered=false;enc.push(q.hanja);
    const d=generateDecoys(q,ALL_HANJA,3,'hanja');
    curQ.opts=shuffle([q,...d]);
    updateUI();
  }
  function updateUI(){
    let h='';
    h+=g3dProgress((1-timeLeft/60)*100,timeLeft<=10?'#EE334E':'#76FF03');
    h+=g3dHUD(g3dBackBtn(),g3dBadge(Math.ceil(timeLeft)+'s',timeLeft<=10?'rgba(238,51,78,.6)':'rgba(0,0,0,.5)'),
      g3dBadge(score+'점','rgba(255,165,0,.5)'));
    // question
    if(curQ&&phase==='race'){
      h+=`<div style="text-align:center;margin-top:4px;pointer-events:none;">
        <div style="font-size:.75rem;color:rgba(255,255,255,.5);">이 훈음의 한자는?</div>
        <div style="font-size:1.3rem;font-weight:800;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.5);">${curQ.fullHunEum}</div></div>`;
      h+=g3dAnswerGrid(curQ.opts.map(o=>({label:o.hanja})),'window._swimAnswer',true);
    }
    // rank display
    const allP=[{n:'나',p:pPos},...cpuPos.map((p,i)=>({n:cpuNames[i],p}))].sort((a,b)=>b.p-a.p);
    const myRank=allP.findIndex(a=>a.n==='나')+1;
    h+=`<div style="position:absolute;top:52px;left:14px;pointer-events:none;">
      <span style="font-size:.8rem;font-weight:800;color:${myRank===1?'#FFD700':'#fff'};text-shadow:0 2px 4px rgba(0,0,0,.5);">${myRank}위</span></div>`;
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._swimAnswer=function(idx){
    if(!curQ||answered||phase!=='race')return;
    answered=true;
    const o=curQ.opts[idx];
    const correctIdx=curQ.opts.findIndex(x=>x.hanja===curQ.hanja);
    markAnswer(idx,correctIdx);
    if(o.hanja===curQ.hanja){
      score++;streak++;pPos=Math.min(95,pPos+6+streak*0.5);
      SoundSystem.playSound('correct');SoundSystem.playSound('splash_sfx');
      GE3D.shake(1,0.15);
      GE3D.burst3d(scene,swimmers3d[0].position.x,0.5,swimmers3d[0].position.z,0x00E5FF,10,2,0.5);
    }else{
      wrong.push(curQ);streak=0;pPos=Math.min(95,pPos+0.5);
      SoundSystem.playSound('wrong');GE3D.shake(2,0.3);
    }
    setTimeout(()=>{if(timeLeft>0)nextQ();},500);
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='race';SoundSystem.playSound('whistle');}updateUI();}}
      if(phase==='race'){
        timeLeft-=dt;if(timeLeft<=0){timeLeft=0;phase='done';return;}
        // cpu
        cpuBase=0.6+(pPos/90)*1.2;
        cpuPos=cpuPos.map((p,i)=>Math.min(95,p+(cpuBase+Math.random()*0.6-0.15)*(0.85+i*0.08)*dt*60/50));
        pPos=Math.min(95,pPos+dt*0.5);
        // update timer display
        if(Math.floor(timeLeft)!==Math.floor(timeLeft+dt))updateUI();
        // panic
        if(timeLeft<=10&&Math.floor(timeLeft*2)%2===0)SoundSystem.playSound('heartbeat');
      }
      // animate water
      waterPhase+=dt;
      if(waterMesh){
        const pos=waterMesh.geometry.attributes.position;
        for(let i=0;i<pos.count;i++){
          const x=pos.getX(i),z=pos.getZ(i);
          pos.setY(i,Math.sin(x*0.5+waterPhase*2)*0.15+Math.cos(z*0.3+waterPhase*1.5)*0.1);
        }
        pos.needsUpdate=true;
      }
      // move swimmers
      if(swimmers3d){
        const allPos=[pPos,...cpuPos];
        const laneZ=[-3.75,-1.25,1.25,3.75];
        allPos.forEach((p,i)=>{
          if(swimmers3d[i]){
            swimmers3d[i].position.x=-5+p/100*20;
            swimmers3d[i].position.y=0.3+Math.sin(performance.now()/200+i)*0.1;
            // arm animation
            const arms=swimmers3d[i].children.filter((c,ci)=>ci===2||ci===3);
            arms.forEach((a,ai)=>{a.rotation.x=Math.sin(performance.now()/150+i+ai*Math.PI)*0.8;});
          }
        });
      }
    },
    onTap(x,y){},
    getResult(){
      recordEncountered(enc);
      const allP=[{n:'나',p:pPos},...cpuPos.map((p,i)=>({n:cpuNames[i],p}))].sort((a,b)=>b.p-a.p);
      const place=allP.findIndex(a=>a.n==='나')+1;
      const m=getMedalForScore('swimming',score);recordGameResult('swimming',score,0,m,wrong);
      return{gameId:'swimming',name:'수영',score,total:0,medal:m,detail:'60초 '+score+'문제 정답 ('+place+'위)'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// WEIGHTLIFTING - 3D POWER STAGE
// ============================
function createWeightliftingGame3D(){
  let scene,camera,streak,wrong,enc,phase,countdown,cdT,altType;
  let curQ,gaugePos,gaugeDir,gaugeSpd,failZone;
  let liftAnim,judgment,judgT,bestStreak;
  let lifter3d,barbell3d,plates3d,spotlight;
  function reset(){
    streak=0;wrong=[];enc=[];phase='countdown';countdown=3;cdT=0;altType=0;
    gaugePos=0;gaugeDir=1;liftAnim=0;judgment='';judgT=0;
    const user=Store.getUser(Store.getCurrentUser());
    bestStreak=(user&&user.bestScores&&user.bestScores.weightlifting)?user.bestScores.weightlifting.score:0;
    // build scene
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x0a0a0a);
    camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,3,8);camera.lookAt(0,2,0);
    // lights
    scene.add(new THREE.AmbientLight(0x221100,0.3));
    spotlight=new THREE.SpotLight(0xffeedd,1.5,30,Math.PI/5,0.5,1);
    spotlight.position.set(0,12,3);spotlight.target.position.set(0,0,0);
    scene.add(spotlight);scene.add(spotlight.target);
    const rimLight=new THREE.PointLight(0x4488ff,0.3,15);rimLight.position.set(-5,5,-2);scene.add(rimLight);
    // stage/platform
    const platform=voxBox(5,0.4,3,0x333333);platform.position.set(0,0.2,0);scene.add(platform);
    const edge=voxBox(5.2,0.15,3.2,0x555555);edge.position.set(0,0.42,0);scene.add(edge);
    // floor
    const floor=voxBox(20,0.1,20,0x111111);floor.position.set(0,-0.05,0);scene.add(floor);
    // audience (voxel silhouettes)
    for(let i=-5;i<=5;i++){
      for(let r=0;r<2;r++){
        const s=voxBox(0.4,0.6,0.3,0x222222);
        s.position.set(i*1.2,0.3+r*0.6,-4-r*1.5);scene.add(s);
        const h=voxBox(0.3,0.3,0.3,0x331111);
        h.position.set(i*1.2,0.9+r*0.6,-4-r*1.5);scene.add(h);
      }
    }
    // lifter
    lifter3d=makeVoxelChar(0xEE334E,0xFFDDB0);
    lifter3d.position.set(0,0.5,0);scene.add(lifter3d);
    // barbell
    barbell3d=new THREE.Group();
    const bar=voxBox(3,0.12,0.12,0x888888);barbell3d.add(bar);
    barbell3d.position.set(0,2.8,0);scene.add(barbell3d);
    plates3d=[];
    nextQ();
  }
  function addPlate(){
    const colors=[0xEE334E,0x0081C8,0x00A651,0xFFD700,0x555555,0x333333,0x888888,0x444444];
    const idx=plates3d.length;
    const ph=0.3+idx*0.06;const pw=0.15+idx*0.03;
    const col=colors[idx%colors.length];
    const lp=voxBox(pw,ph,pw,col);lp.position.set(-1.5-idx*0.2,0,0);barbell3d.add(lp);
    const rp=voxBox(pw,ph,pw,col);rp.position.set(1.5+idx*0.2,0,0);barbell3d.add(rp);
    plates3d.push({l:lp,r:rp});
  }
  function nextQ(){
    const q=ALL_HANJA[Math.floor(Math.random()*ALL_HANJA.length)];enc.push(q.hanja);
    const isH=altType%2===0;altType++;
    if(isH){
      const d=generateDecoys(q,ALL_HANJA,3,'fullHunEum');
      curQ={q,text:'이 한자의 훈음은?',display:q.hanja,isH:true,opts:shuffle([q,...d]).map(o=>({l:o.fullHunEum,v:o.fullHunEum,ok:o.fullHunEum===q.fullHunEum}))};
    }else{
      const d=generateDecoys(q,ALL_HANJA,3,'hanja');
      curQ={q,text:'이 훈음의 한자는?',display:q.fullHunEum,isH:false,opts:shuffle([q,...d]).map(o=>({l:o.hanja,v:o.hanja,ok:o.hanja===q.hanja,h:true}))};
    }
    curQ.answered=false;curQ._sel=null;
    if(phase!=='countdown')phase='quiz';
    updateUI();
  }
  function updateUI(){
    const kg=40+streak*10;
    let h='';
    h+=g3dProgress(Math.min(streak/15,1)*100,'#76FF03');
    h+=g3dHUD(g3dBackBtn(),
      `<div style="text-align:center;"><div style="font-size:1.8rem;font-weight:900;color:#FFD700;text-shadow:0 0 15px rgba(255,215,0,.4);">${kg}kg</div>
      <div style="font-size:.7rem;color:rgba(255,255,255,.5);">연속 ${streak}</div></div>`,
      (streak>=bestStreak&&streak>0?g3dBadge('🔥신기록!','rgba(238,51,78,.5)'):''));
    if(phase==='quiz'&&curQ){
      h+=`<div style="text-align:center;margin-top:8px;pointer-events:none;">
        <div style="font-size:.75rem;color:rgba(255,255,255,.5);">${curQ.text}</div>
        <div style="font-size:${curQ.isH?'2.5rem':'1.3rem'};font-weight:800;color:#fff;margin-top:4px;">${curQ.display}</div></div>`;
      h+=g3dAnswerGrid(curQ.opts.map(o=>({label:o.l})),'window._wlAnswer',curQ.opts[0]&&curQ.opts[0].h);
    }
    if(phase==='gauge'){
      failZone=Math.min(30+streak*2,50);
      h+=`<div style="position:absolute;bottom:40px;left:5%;right:5%;pointer-events:auto;">
        <div style="text-align:center;color:#FFD700;font-weight:800;font-size:.9rem;margin-bottom:8px;">탭하여 멈추세요!</div>
        <div style="height:36px;border-radius:18px;position:relative;overflow:hidden;background:#EE334E;box-shadow:inset 0 3px 6px rgba(0,0,0,.3);">
          <div style="position:absolute;left:${failZone}%;top:0;bottom:0;width:${60-failZone}%;background:#FCB131;"></div>
          <div style="position:absolute;left:60%;top:0;bottom:0;width:25%;background:#00A651;"></div>
          <div style="position:absolute;left:85%;top:0;bottom:0;width:15%;background:#FFD700;border-radius:0 18px 18px 0;"></div>
          <div style="position:absolute;top:0;bottom:0;left:${gaugePos}%;width:4px;background:#fff;box-shadow:0 0 8px #fff;z-index:2;"></div>
        </div>
        <button class="g3d-btn" onclick="window._wlGaugeStop()" style="width:100%;margin-top:10px;padding:14px;border-radius:14px;background:rgba(255,215,0,.3);border:2px solid #FFD700;color:#FFD700;font-weight:800;font-size:1.1rem;cursor:pointer;">STOP!</button>
      </div>`;
    }
    if(judgT>0&&judgment){
      const col=judgment==='perfect'?'#FFD700':judgment==='great'?'#00E5FF':judgment==='ok'?'#fff':'#EE334E';
      h+=`<div style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900;color:${col};text-shadow:0 0 20px ${col};">${judgment.toUpperCase()}!</div>`;
    }
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._wlAnswer=function(idx){
    if(!curQ||curQ.answered||phase!=='quiz')return;
    curQ.answered=true;curQ._sel=curQ.opts[idx].v;
    const correctIdx=curQ.opts.findIndex(o=>o.ok);
    markAnswer(idx,correctIdx);
    if(curQ.opts[idx].ok){
      SoundSystem.playSound('correct');GE3D.shake(0.5,0.15);
      phase='gauge';gaugePos=0;gaugeDir=1;
      SoundSystem.playSound('power_charge');
      setTimeout(updateUI,300);
    }else{
      wrong.push(curQ.q);SoundSystem.playSound('wrong');GE3D.shake(3,0.4);
      SoundSystem.playSound('impact_heavy');
      judgment='fail';judgT=1.5;liftAnim=0;
      GE3D.burst3d(scene,0,2,0,0xEE334E,15,3,0.6);
      setTimeout(()=>{phase='done';},1500);
    }
  };
  window._wlGaugeStop=function(){
    if(phase!=='gauge')return;
    SoundSystem.playSound('gauge_stop');
    failZone=Math.min(30+streak*2,50);
    if(gaugePos<failZone){
      judgment='fail';GE3D.shake(3,0.5);SoundSystem.playSound('impact_heavy');
      GE3D.burst3d(scene,0,2,0,0xEE334E,15,3,0.6);
      judgT=1.5;liftAnim=0;setTimeout(()=>{phase='done';},1500);
    }else if(gaugePos<60){
      judgment='ok';streak++;addPlate();GE3D.shake(1,0.2);SoundSystem.playSound('impact_light');
      judgT=1.5;liftAnim=0;setTimeout(()=>nextQ(),1200);
    }else if(gaugePos<85){
      judgment='great';streak++;addPlate();GE3D.shake(1.5,0.3);SoundSystem.playSound('metal_clang');
      GE3D.burst3d(scene,0,3,0,0x00E5FF,12,3,0.5);
      judgT=1.5;liftAnim=0;setTimeout(()=>nextQ(),1200);
    }else{
      judgment='perfect';streak++;addPlate();GE3D.shake(2,0.4);SoundSystem.playSound('metal_clang');SoundSystem.playSound('cheer');
      GE3D.burst3d(scene,0,3.5,0,0xFFD700,25,5,0.8);
      judgT=1.5;liftAnim=0;setTimeout(()=>nextQ(),1200);
    }
    phase='lift';updateUI();
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='quiz';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(phase==='gauge'){
        gaugeSpd=2.5+streak*0.5;
        gaugePos+=gaugeDir*gaugeSpd*dt*60;
        if(gaugePos>=100){gaugePos=100;gaugeDir=-1;}
        if(gaugePos<=0){gaugePos=0;gaugeDir=1;}
        updateUI();
      }
      if(phase==='lift'){
        liftAnim+=dt;
        const lift=judgment==='perfect'?1.5:judgment==='great'?1:judgment==='ok'?0.6:-0.3;
        barbell3d.position.y=2.8+lift*Math.min(liftAnim/0.5,1);
        lifter3d.children[0].position.y=0.4+(lift>0?0.1:0)*Math.min(liftAnim/0.5,1);
      }else{
        barbell3d.position.y=2.8;
      }
      if(judgT>0){judgT-=dt;if(judgT<=0)updateUI();}
      // lifter idle animation
      if(lifter3d){
        lifter3d.children[0].position.y=0.4+Math.sin(performance.now()/500)*0.03;
      }
      // spotlight flicker
      if(spotlight)spotlight.intensity=1.5+Math.sin(performance.now()/300)*0.1;
    },
    onTap(x,y){},
    getResult(){
      recordEncountered(enc);const m=getMedalForScore('weightlifting',streak);
      recordGameResult('weightlifting',streak,0,m,wrong);
      return{gameId:'weightlifting',name:'역도',score:streak,total:0,medal:m,detail:'연속 '+streak+'문제 ('+(40+streak*10)+'kg)'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// GYMNASTICS - 3D CARD MATCH
// ============================
// GYMNASTICS - 3D CARD MATCH
// ============================
function createGymnasticsGame3D(){
  let scene,camera,cards3d,flipped,matchCount,attempts,locked,combo,maxCombo,timeLeft,phase,countdown,cdT,peekT;
  let raycaster,mouse,clickBound=false;
  function reset(){
    flipped=[];matchCount=0;attempts=0;locked=true;combo=0;maxCombo=0;
    timeLeft=90;phase='countdown';countdown=3;cdT=0;peekT=3;
    scene=new THREE.Scene();scene.background=new THREE.Color(0x1a0a2e);
    scene.fog=new THREE.FogExp2(0x1a0a2e,0.03);
    camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,8,7);camera.lookAt(0,0,0);
    scene.add(new THREE.AmbientLight(0x332266,0.5));
    const dL=new THREE.DirectionalLight(0xeeddff,0.6);dL.position.set(3,8,5);scene.add(dL);
    scene.add(new THREE.PointLight(0x9966ff,0.8,20));
    const pGeo=new THREE.BufferGeometry();const pPos=[];
    for(let i=0;i<100;i++)pPos.push((Math.random()-.5)*20,Math.random()*10,(Math.random()-.5)*20);
    pGeo.setAttribute('position',new THREE.Float32BufferAttribute(pPos,3));
    scene.add(new THREE.Points(pGeo,new THREE.PointsMaterial({color:0x9966ff,size:0.08,transparent:true,opacity:0.5})));
    const floor=voxBox(12,0.05,8,0x150a25);floor.position.y=-0.5;scene.add(floor);
    const pool=shuffle(ALL_HANJA).slice(0,8);let cardData=[];
    pool.forEach(h=>{
      cardData.push({type:'hanja',pairId:h.hanja,display:h.hanja,isFaceUp:false,isMatched:false});
      cardData.push({type:'huneum',pairId:h.hanja,display:h.fullHunEum,isFaceUp:false,isMatched:false});
    });
    cardData=shuffle(cardData);cards3d=[];
    const cols=4,rows=4,cardW=1.5,cardH=2,gap=0.3;
    const totalW=cols*(cardW+gap)-gap,totalH=rows*(cardH+gap)-gap;
    const startX=-totalW/2+cardW/2,startZ=-totalH/2+cardH/2;
    cardData.forEach((cd,i)=>{
      const col=i%cols,row=Math.floor(i/cols);
      const grp=new THREE.Group();
      const back=voxBoxPhong(cardW,0.08,cardH,0x6C63FF,0x3311aa);back.position.y=0.04;grp.add(back);
      const front=voxBoxPhong(cardW,0.08,cardH,0xffffff,0x000000);front.position.y=-0.04;front.visible=false;grp.add(front);
      // Add text label on front face using canvas texture
      const labelTex=makeTextCanvas(cd.display,cd.type==='hanja'?120:40,cd.type==='hanja'?'#333':'#0066cc','#ffffff',256,256);
      const labelGeo=new THREE.PlaneGeometry(cardW*0.85,cardH*0.85);
      const labelMat=new THREE.MeshBasicMaterial({map:labelTex,transparent:false,side:THREE.DoubleSide});
      const labelMesh=new THREE.Mesh(labelGeo,labelMat);
      labelMesh.rotation.x=-Math.PI/2;labelMesh.position.y=-0.09;
      grp.add(labelMesh);
      // Back "?" label
      const backTex=makeTextCanvas('?',100,'rgba(255,255,255,0.6)','rgba(108,99,255,0)',256,256);
      const backLabelMesh=new THREE.Mesh(new THREE.PlaneGeometry(cardW*0.6,cardH*0.6),
        new THREE.MeshBasicMaterial({map:backTex,transparent:true,side:THREE.DoubleSide}));
      backLabelMesh.rotation.x=-Math.PI/2;backLabelMesh.position.y=0.09;grp.add(backLabelMesh);
      grp.position.set(startX+col*(cardW+gap),0,startZ+row*(cardH+gap));
      grp.userData={...cd,idx:i,front,back,flipAngle:Math.PI,targetFlip:Math.PI,labelMesh,backLabelMesh};
      scene.add(grp);cards3d.push(grp);
    });
    raycaster=new THREE.Raycaster();mouse=new THREE.Vector2();
    updateUI();
  }
  function flipCard(card,faceUp){
    card.userData.isFaceUp=faceUp;
    card.userData.targetFlip=faceUp?Math.PI:0;
    SoundSystem.playSound('flip');
  }
  function updateUI(){
    let h='';
    h+=g3dProgress(matchCount/8*100,'#E040FB');
    h+=g3dHUD(g3dBackBtn(),g3dBadge(matchCount+'/8','rgba(108,99,255,.5)'),
      g3dBadge(Math.ceil(timeLeft)+'s',timeLeft<=15?'rgba(238,51,78,.6)':'rgba(0,0,0,.5)'));
    if(combo>=2){
      const tier=combo>=5?'ULTRA':combo>=3?'SUPER':'COMBO';
      const cc=combo>=5?'#FFD700':combo>=3?'#E040FB':'#00E5FF';
      h+=`<div style="text-align:center;margin-top:8px;pointer-events:none;">
        <div style="font-size:${1+combo*0.2}rem;font-weight:900;color:${cc};text-shadow:0 0 15px ${cc};">${combo}x ${tier}!</div></div>`;
    }
    if(phase==='peek')h+=`<div style="position:absolute;bottom:30px;left:0;right:0;text-align:center;pointer-events:none;">
      <span style="font-size:1.2rem;font-weight:800;color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,.5);">카드를 기억하세요! ${Math.ceil(peekT)}</span></div>`;
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  function onContainerClick(e){
    if(locked||phase!=='play')return;
    const rect=GE3D.renderer.domElement.getBoundingClientRect();
    mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
    mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
    raycaster.setFromCamera(mouse,camera);
    const intersects=raycaster.intersectObjects(cards3d.flatMap(c=>c.children));
    if(intersects.length>0){
      const card=intersects[0].object.parent;
      if(!card.userData||card.userData.isMatched||card.userData.isFaceUp)return;
      if(flipped.length>=2)return;
      flipCard(card,true);flipped.push(card);
      if(flipped.length===2){
        locked=true;attempts++;
        const a=flipped[0].userData,b=flipped[1].userData;
        if(a.pairId===b.pairId&&a.type!==b.type){
          setTimeout(()=>{
            a.isMatched=true;b.isMatched=true;matchCount++;combo++;
            if(combo>maxCombo)maxCombo=combo;
            SoundSystem.playSound('combo_hit');
            const cx=(flipped[0].position.x+flipped[1].position.x)/2;
            const cz=(flipped[0].position.z+flipped[1].position.z)/2;
            const bcol=combo>=5?0xFFD700:combo>=3?0xE040FB:0x00E5FF;
            GE3D.burst3d(scene,cx,1,cz,bcol,combo>=5?25:combo>=3?15:8,combo>=3?4:2,0.6);
            if(combo>=3)GE3D.shake(combo>=5?2:1,0.2);
            timeLeft+=combo>=4?8:5;
            [flipped[0],flipped[1]].forEach(c=>{
              c.userData.front.material=new THREE.MeshPhongMaterial({color:0x66ff66,emissive:0x00ff00,emissiveIntensity:0.3});
            });
            flipped=[];locked=false;updateUI();
            if(matchCount===8){phase='done';SoundSystem.playSound('cheer');GE3D.burst3d(scene,0,2,0,0xFFD700,40,5,1);}
          },300);
        }else{
          combo=0;SoundSystem.resetCombo();
          setTimeout(()=>{SoundSystem.playSound('wrong');flipCard(flipped[0],false);flipCard(flipped[1],false);GE3D.shake(0.5,0.15);flipped=[];locked=false;updateUI();},600);
        }
      }
    }
  }
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;
      if(!clickBound){GE3D.container.addEventListener('pointerdown',onContainerClick);clickBound=true;}},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='peek';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(phase==='peek'){peekT-=dt;if(peekT<=0){phase='play';locked=false;cards3d.forEach(c=>{flipCard(c,false);});updateUI();}}
      if(phase==='play'){timeLeft-=dt;if(timeLeft<=0){timeLeft=0;phase='done';}if(Math.floor(timeLeft)!==Math.floor(timeLeft+dt))updateUI();}
      cards3d.forEach(c=>{
        const target=c.userData.targetFlip;const current=c.userData.flipAngle||0;
        const diff=target-current;
        if(Math.abs(diff)>0.01){
          c.userData.flipAngle=current+diff*Math.min(dt*8,1);
          c.rotation.x=c.userData.flipAngle;
          const isFront=c.userData.flipAngle>Math.PI/2;
          c.userData.front.visible=isFront;c.userData.back.visible=!isFront;
          c.userData.labelMesh.visible=isFront;c.userData.backLabelMesh.visible=!isFront;
        }
        if(c.userData.isMatched){c.position.y=Math.min(c.position.y+dt*0.5,2);}
        if(!c.userData.isMatched){c.position.y=Math.sin(performance.now()/1000+c.userData.idx)*0.05;}
      });
    },
    onTap(){},
    getResult(){
      const enc2=cards3d.filter(c=>c.userData.type==='hanja').map(c=>c.userData.pairId);recordEncountered(enc2);
      const m=getMedalForScore('gymnastics',attempts);recordGameResult('gymnastics',attempts,0,m,[]);
      return{gameId:'gymnastics',name:'체조',score:attempts,total:0,medal:m,detail:attempts+'회 시도 (최대콤보 '+maxCombo+', 남은시간 '+Math.ceil(timeLeft)+'초)'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}GE3D.container.removeEventListener('pointerdown',onContainerClick);clickBound=false;},
    isDone(){return phase==='done';}
  };
}
// ============================
// MARATHON - 3D SURVIVAL RUNNER
// ============================
// MARATHON - 3D OBSTACLE RUNNER
// ============================
function createMarathonGame3D(){
  let scene,camera,qs,cur,score,wrong,enc,hp,streak,speedLv,phase,countdown,cdT,startTime;
  let runner3d,trees3d,walls3d,roadOffset,runFrame,wallZ,wallHit;
  const spdNames=['조깅','달리기','스프린트','전력질주!'];
  const spdCols=['#4CAF50','#FF9800','#E91E63','#FFD700'];
  let heartbeatT,curOpts,wallPhase;
  function reset(){
    qs=shuffle(ALL_HANJA);cur=0;score=0;wrong=[];enc=[];hp=5;streak=0;speedLv=0;
    phase='countdown';countdown=3;cdT=0;startTime=Date.now();
    roadOffset=0;runFrame=0;heartbeatT=0;wallZ=-20;wallHit=false;wallPhase='approaching';
    scene=new THREE.Scene();scene.background=new THREE.Color(0x87CEEB);
    scene.fog=new THREE.Fog(0x87CEEB,20,60);
    camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,4,6);camera.lookAt(0,1,-5);
    scene.add(new THREE.AmbientLight(0x88aacc,0.7));
    const sun=new THREE.DirectionalLight(0xffeedd,0.9);sun.position.set(5,10,5);scene.add(sun);
    // sun sphere
    const sunM=new THREE.Mesh(new THREE.SphereGeometry(2,16,16),new THREE.MeshBasicMaterial({color:0xFFDD44}));
    sunM.position.set(15,12,-25);scene.add(sunM);
    // clouds
    for(let i=0;i<6;i++){
      const cg=new THREE.Group();
      cg.add(voxBox(2,0.6,1,0xffffff));
      const c2=voxBox(1.5,0.5,0.8,0xeeeeee);c2.position.set(0.8,0.2,0);cg.add(c2);
      cg.position.set(-15+i*6,8+Math.random()*3,-15);cg.userData={speed:0.2+Math.random()*0.3};
      scene.add(cg);
    }
    // road (long)
    for(let z=10;z>=-40;z-=2){
      const g=voxBox(16,0.3,2,z%4===0?0x4CAF50:0x388E3C);g.position.set(0,-0.15,z);scene.add(g);
      const r=voxBox(5,0.35,2,0x555555);r.position.set(0,0,z);scene.add(r);
      if(z%4===0){const m=voxBox(0.8,0.36,0.15,0xFFD700);m.position.set(0,0,z);scene.add(m);}
    }
    // trees
    trees3d=[];
    for(let i=0;i<16;i++){
      const side=i%2===0?-1:1;
      const t=makeVoxelTree(side*(4+Math.random()*3),8-i*3,0.6+Math.random()*0.4);
      scene.add(t);trees3d.push(t);
    }
    // mountains
    for(let i=0;i<5;i++){
      const mw=3+Math.random()*4,mh=2+Math.random()*3;
      const mt=voxBox(mw,mh,mw,0x556B2F);mt.position.set(-12+i*6,mh/2-0.5,-30);scene.add(mt);
      const pk=voxBox(mw*0.5,mh*0.5,mw*0.5,0x778899);pk.position.set(-12+i*6,mh-0.5,-30);scene.add(pk);
    }
    // runner
    runner3d=makeVoxelChar(0x0081C8,0xFFDDB0);
    runner3d.position.set(0,0.5,0);runner3d.scale.setScalar(0.8);scene.add(runner3d);
    walls3d=[];
    setupQ();
  }
  function setupQ(){
    if(cur>=qs.length||hp<=0){phase='done';return;}
    const q=qs[cur];enc.push(q.hanja);
    const d=generateDecoys(q,ALL_HANJA,3,'fullHunEum');
    curOpts=shuffle([q,...d]);
    // create 4 walls ahead
    walls3d.forEach(w=>scene.remove(w.group));walls3d=[];
    const positions=[-2.2,-0.75,0.75,2.2];
    curOpts.forEach((o,i)=>{
      const grp=new THREE.Group();
      const isCorrect=o.fullHunEum===q.fullHunEum;
      const wallColor=isCorrect?0x228B22:0x8B0000;
      const wall=voxBox(1.3,2.5,0.4,0x888888);wall.position.y=1.25;grp.add(wall);
      // label sprite
      const label=makeTextSprite(o.fullHunEum,1.2,'#fff','rgba(40,40,40,0.85)');
      label.position.y=2.8;grp.add(label);
      grp.position.set(positions[i],0,-20);
      grp.userData={correct:isCorrect,idx:i,broken:false};
      scene.add(grp);walls3d.push({group:grp,correct:isCorrect,broken:false});
    });
    wallZ=-20;wallHit=false;wallPhase='approaching';
    if(phase!=='countdown')phase='run';
    updateUI();
  }
  function updateUI(){
    const pct=cur/qs.length;
    let h='';
    h+=g3dProgress(pct*100,'#76FF03');
    let hearts='';for(let i=0;i<5;i++)hearts+=`<span style="font-size:1.2rem;${i>=hp?'filter:grayscale(1) opacity(.3);':''}">${i<hp?'❤️':'🖤'}</span>`;
    h+=g3dHUD(g3dBackBtn()+`<span style="display:flex;gap:2px;margin-left:8px;">${hearts}</span>`,
      `<span style="padding:4px 14px;border-radius:12px;font-size:.8rem;font-weight:800;background:${spdCols[speedLv]};color:#fff;">${spdNames[speedLv]}</span>`,
      g3dBadge((pct*42.195).toFixed(1)+'km','rgba(0,0,0,.5)'));
    if(cur<qs.length&&phase==='run'){
      h+=`<div style="text-align:center;margin-top:4px;pointer-events:none;">
        <div style="font-size:.7rem;color:rgba(255,255,255,.5);">이 한자의 훈음은?</div>
        <div style="font-size:2.5rem;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3);">${qs[cur].hanja}</div></div>`;
      h+=`<div style="position:absolute;bottom:12px;left:0;right:0;display:flex;justify-content:center;gap:8px;padding:0 12px;pointer-events:auto;">`;
      curOpts.forEach((o,i)=>{
        h+=`<button class="g3d-btn g3d-ans" data-idx="${i}" onclick="window._marathonAnswer(${i})"
          style="flex:1;padding:14px 6px;border-radius:14px;font-size:.95rem;font-weight:800;
          background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);color:#fff;
          cursor:pointer;backdrop-filter:blur(8px);text-shadow:0 1px 3px rgba(0,0,0,.4);
          font-family:inherit;text-align:center;">${o.fullHunEum}</button>`;
      });
      h+=`</div>`;
    }
    if(hp<=1)h+=`<div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;box-shadow:inset 0 0 80px 30px rgba(238,51,78,.4);z-index:-1;"></div>`;
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._marathonAnswer=function(idx){
    if(phase!=='run'||wallHit)return;
    wallHit=true;
    const o=curOpts[idx];const q=qs[cur];
    const isCorrect=o.fullHunEum===q.fullHunEum;
    const correctIdx=curOpts.findIndex(x=>x.fullHunEum===q.fullHunEum);
    markAnswer(idx,correctIdx);
    // runner dashes toward selected wall
    const targetWall=walls3d[idx];
    if(isCorrect){
      score++;streak++;speedLv=Math.min(3,Math.floor(streak/3));
      SoundSystem.playSound('correct');
      // break wall
      setTimeout(()=>{
        if(targetWall){
          targetWall.broken=true;
          GE3D.burst3d(scene,targetWall.group.position.x,1.5,targetWall.group.position.z,0x76FF03,15,4,0.6);
          targetWall.group.visible=false;
        }
        GE3D.shake(1,0.2);SoundSystem.playSound('impact_light');
        if(streak>0&&streak%5===0&&hp<5){hp++;SoundSystem.playSound('combo_hit');}
      },200);
    }else{
      wrong.push(q);streak=0;speedLv=0;hp--;
      SoundSystem.playSound('wrong');SoundSystem.playSound('impact_heavy');
      setTimeout(()=>{
        GE3D.shake(3,0.5);
        GE3D.burst3d(scene,runner3d.position.x,1,runner3d.position.z-1,0xEE334E,20,3,0.6);
        // show correct wall green
        walls3d.forEach((w,i)=>{if(i===correctIdx)w.group.children[0].material=new THREE.MeshLambertMaterial({color:0x00ff00,emissive:0x00ff00,emissiveIntensity:0.3});});
      },200);
      if(hp<=0){setTimeout(()=>{phase='done';updateUI();},800);return;}
    }
    setTimeout(()=>{cur++;setupQ();},800);
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='run';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(phase!=='run')return;
      speedLv=Math.min(3,Math.floor(streak/3));
      const spd=1+speedLv*0.5;
      runFrame+=dt*6*(1+speedLv);
      // runner animation
      if(runner3d){
        runner3d.position.y=0.5+Math.abs(Math.sin(runFrame))*0.2;
        const legs=runner3d.children.filter((c,i)=>i>=4);
        legs.forEach((l,i)=>{l.rotation.x=Math.sin(runFrame*2+i*Math.PI)*0.6;});
        const arms=runner3d.children.filter((c,i)=>i===2||i===3);
        arms.forEach((a,i)=>{a.rotation.x=Math.sin(runFrame*2+i*Math.PI+Math.PI/2)*0.5;});
      }
      // walls approach runner
      if(!wallHit){
        wallZ+=dt*3*spd;
        walls3d.forEach(w=>{w.group.position.z=wallZ+20+w.group.position.z;w.group.position.z=wallZ;});
      }
      // trees scroll
      trees3d.forEach(t=>{t.position.z+=dt*5*spd;if(t.position.z>10)t.position.z-=48;});
      // clouds
      scene.children.forEach(c=>{if(c.userData&&c.userData.speed){c.position.x+=c.userData.speed*spd*dt*2;if(c.position.x>20)c.position.x=-20;}});
      camera.position.y=4+Math.sin(performance.now()/800)*0.05;
      if(hp===1){heartbeatT+=dt;if(heartbeatT>=0.8){heartbeatT=0;SoundSystem.playSound('heartbeat');}}
    },
    onTap(){},
    getResult(){
      recordEncountered(enc);
      const pct=Math.round(score/qs.length*100);const m=getMedalForScore('marathon',pct);
      const elapsed=formatTime(Date.now()-startTime);
      recordGameResult('marathon',pct,100,m,wrong);
      return{gameId:'marathon',name:'마라톤',score:pct,total:100,medal:m,detail:score+'/'+qs.length+' ('+pct+'%) - '+elapsed+(hp<=0?' [HP 소진]':'')};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}



// ============================
// ANTONYM - ARCHERY VARIANT (반의어 양궁)
// ============================
function createAntonymGame3D(){
  let scene,camera,pairs,cur,score,bonus,wrong,enc,phase,targets3d,arrow3d,arrowT;
  let countdown,cdT,starField;
  const targetData=[];
  pairs=[...ANTONYM_PAIRS].sort(()=>Math.random()-0.5).slice(0,10);
  function reset(){
    cur=0;score=0;bonus=0;wrong=[];enc=[];
    phase='countdown';countdown=3;cdT=0;
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x1a0a2e);
    scene.fog=new THREE.FogExp2(0x1a0a2e,0.02);
    camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,0.1,200);
    camera.position.set(0,3,10);camera.lookAt(0,2,0);
    scene.add(new THREE.AmbientLight(0x442266,0.5));
    const dL=new THREE.DirectionalLight(0xeeddff,0.7);dL.position.set(5,10,5);scene.add(dL);
    const pL1=new THREE.PointLight(0xff44aa,0.8,20);pL1.position.set(-4,5,2);scene.add(pL1);
    const pL2=new THREE.PointLight(0x4488ff,0.8,20);pL2.position.set(4,5,2);scene.add(pL2);
    // stars
    const sGeo=new THREE.BufferGeometry();const sPos=[];
    for(let i=0;i<500;i++)sPos.push((Math.random()-.5)*100,Math.random()*50,(Math.random()-.5)*100-20);
    sGeo.setAttribute('position',new THREE.Float32BufferAttribute(sPos,3));
    starField=new THREE.Points(sGeo,new THREE.PointsMaterial({color:0xffffff,size:0.15,transparent:true,opacity:0.8}));
    scene.add(starField);
    // ground - purple arena
    const gnd=voxBox(40,0.3,30,0x1a0a1a);gnd.position.set(0,-0.5,-5);scene.add(gnd);
    // glowing pillars
    for(let i=-3;i<=3;i+=2){
      const p=voxBox(0.3,4,0.3,0x6633aa);p.position.set(i*2,2,-5);scene.add(p);
      const top=voxBox(0.5,0.3,0.5,0xff44aa);top.position.set(i*2,4,-5);scene.add(top);
    }
    // yin-yang pedestal
    const base=voxBox(2,0.3,1,0x6633aa);base.position.set(0,0,7);scene.add(base);
    setupQ();
  }
  function setupQ(){
    targetData.length=0;
    if(targets3d){targets3d.forEach(t=>scene.remove(t.group));}
    targets3d=[];
    if(cur>=pairs.length){phase='done';return;}
    const [a,b]=pairs[cur];
    const ha=ALL_HANJA.find(x=>x.hanja===a);
    const hb=ALL_HANJA.find(x=>x.hanja===b);
    enc.push(a,b);
    // correct answer is b (antonym of a)
    // generate 3 wrong options (other hanja that are NOT b)
    let decoys=ALL_HANJA.filter(x=>x.hanja!==b&&x.hanja!==a).sort(()=>Math.random()-0.5).slice(0,3);
    const opts=shuffle([hb,...decoys]);
    const positions=[[-2.5,3.5,-3],[2.5,3.5,-3],[-2.5,1.5,-3],[2.5,1.5,-3]];
    opts.forEach((o,i)=>{
      const [px,py,pz]=positions[i];
      const grp=new THREE.Group();
      // target rings
      const r4=voxBox(1.4,1.4,0.15,0xffffff);grp.add(r4);
      const r3=voxBox(1.1,1.1,0.2,0x6633aa);grp.add(r3);
      const r2=voxBox(0.8,0.8,0.25,0xff44aa);grp.add(r2);
      const r1=voxBox(0.5,0.5,0.3,0xFFD700);grp.add(r1);
      grp.position.set(px,py,pz);scene.add(grp);
      const label=o.hanja+' ('+o.hun+')';
      const isCorr=o.hanja===b;
      const data={group:grp,label,correct:isCorr,bobPhase:Math.random()*Math.PI*2,baseY:py,hit:false};
      targets3d.push(data);targetData.push(data);
    });
    arrow3d=null;arrowT=0;
    if(phase!=='countdown')phase='aim';
    updateUI();
  }
  function updateUI(){
    let h='';
    h+=g3dProgress(cur/pairs.length*100,'#ff44aa');
    h+=g3dHUD(g3dBackBtn(),cur<pairs.length?`<span style="font-size:.75rem;color:rgba(255,255,255,.5);">반대말을 맞추세요</span>`:'',
      g3dBadge((cur<pairs.length?cur+1:pairs.length)+'/'+pairs.length,'rgba(0,0,0,.5)')+' '+g3dBadge(score+'pts','rgba(255,68,170,.5)'));
    if(cur<pairs.length){
      const [a]=pairs[cur];const ha=ALL_HANJA.find(x=>x.hanja===a);
      h+=`<div style="text-align:center;margin-top:8px;pointer-events:none;">
        <div style="font-size:.8rem;color:rgba(255,255,255,.5);">반대말은?</div>
        <div style="font-size:3.5rem;font-weight:900;color:rgba(255,255,255,.9);text-shadow:0 0 20px rgba(255,68,170,.3);">${a}</div>
        <div style="font-size:.9rem;color:rgba(255,255,255,.5);">${ha?ha.hun+' '+ha.eum:''}</div></div>`;
    }
    if(targets3d&&phase==='aim'){
      h+=`<div style="position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:8px;pointer-events:auto;">`;
      targets3d.forEach((t,i)=>{
        h+=`<button class="g3d-btn" onclick="window._antonymTap(${i})" style="padding:10px 14px;border-radius:12px;font-size:.9rem;font-weight:700;
          background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);color:#fff;cursor:pointer;backdrop-filter:blur(4px);
          min-width:70px;text-shadow:0 1px 2px rgba(0,0,0,.4);">${t.label}</button>`;
      });
      h+=`</div>`;
    }
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._antonymTap=function(idx){
    if(phase!=='aim')return;
    const t=targets3d[idx];if(!t||t.hit)return;
    t.hit=true;phase='flying';
    SoundSystem.playSound('whoosh');
    const ag=new THREE.Group();
    const shaft=voxBox(0.08,0.08,1.5,0xff44aa);ag.add(shaft);
    const tip=new THREE.Mesh(new THREE.ConeGeometry(0.1,0.3,4),new THREE.MeshLambertMaterial({color:0xFFD700}));
    tip.rotation.x=Math.PI/2;tip.position.z=-0.9;ag.add(tip);
    ag.position.set(0,1,7);scene.add(ag);
    arrow3d={mesh:ag,target:t.group.position.clone(),startPos:new THREE.Vector3(0,1,7)};arrowT=0;
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='aim';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(targets3d)targets3d.forEach(t=>{if(!t.hit){t.bobPhase+=dt*1.5;t.group.position.y=t.baseY+Math.sin(t.bobPhase)*0.3;t.group.rotation.y+=dt*0.3;}});
      if(starField)starField.rotation.y+=dt*0.01;
      if(arrow3d&&phase==='flying'){
        arrowT+=dt*2;const p=Math.min(arrowT,1);
        arrow3d.mesh.position.lerpVectors(arrow3d.startPos,arrow3d.target,p);
        arrow3d.mesh.position.y+=Math.sin(p*Math.PI)*1.5;
        arrow3d.mesh.lookAt(arrow3d.target);
        if(arrowT>=1){
          scene.remove(arrow3d.mesh);
          const t=targets3d.find(t=>t.hit);
          if(t){
            if(t.correct){
              score++;let bp=0;
              if(arrowT<1.05){bp=3;}else if(arrowT<1.1){bp=2;}else{bp=1;}
              bonus+=bp;
              GE3D.shake(bp>=3?2:bp>=2?1.5:1,bp>=3?0.4:0.3);
              GE3D.burst3d(scene,t.group.position.x,t.group.position.y,t.group.position.z,0x44ff88,bp>=3?25:15,bp>=3?5:3,0.8);
              SoundSystem.playSound(bp>=2?'impact_heavy':'impact_light');SoundSystem.playSound('correct');
              t.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0x00FF00,emissive:0x00FF00,emissiveIntensity:0.5});});
            }else{
              wrong.push(pairs[cur].join('↔'));
              GE3D.shake(2,0.3);SoundSystem.playSound('wrong');SoundSystem.playSound('impact_heavy');
              GE3D.burst3d(scene,t.group.position.x,t.group.position.y,t.group.position.z,0xEE334E,12,3,0.5);
              t.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0xEE334E,emissive:0xEE334E,emissiveIntensity:0.3});});
              targets3d.filter(t2=>t2.correct).forEach(t2=>{t2.group.children.forEach(c=>{c.material=new THREE.MeshLambertMaterial({color:0x00FF00,emissive:0x00FF00,emissiveIntensity:0.3});});});
            }
          }
          phase='wait';arrow3d=null;updateUI();
          setTimeout(()=>{cur++;setupQ();},900);
        }
      }
    },
    onTap(){},
    getResult(){
      recordEncountered(enc);const m=getMedalForScore('antonym',score);
      recordGameResult('antonym',score,10,m,wrong);
      return{gameId:'antonym',name:'반의어',score,total:10,medal:m,detail:score+'/'+pairs.length+' 적중 (보너스 +'+bonus+')'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// IDIOM - MARATHON VARIANT (사자성어 마라톤)
// ============================
function createIdiomGame3D(){
  let scene,camera,qs,cur,score,wrong,enc,hp,streak,speedLv,phase,countdown,cdT,startTime;
  let runner3d,trees3d,walls3d,roadOffset,runFrame,wallZ,wallHit;
  const spdNames=['산책','걷기','달리기','전력질주!'];
  const spdCols=['#4CAF50','#FF9800','#E91E63','#FFD700'];
  let heartbeatT,curOpts,wallPhase;
  // prepare idiom questions - show idiom, pick meaning
  const allIdioms=[...IDIOMS];
  const extraMeanings=['물과 불처럼 맞지 않음','서로 힘을 합침','옛것을 배워 새것을 앎','마음을 하나로 모음','하루가 천년 같음','어려운 일을 해냄'];
  function reset(){
    qs=allIdioms.sort(()=>Math.random()-0.5);
    cur=0;score=0;wrong=[];enc=[];hp=3;streak=0;speedLv=0;
    phase='countdown';countdown=3;cdT=0;startTime=Date.now();
    roadOffset=0;runFrame=0;heartbeatT=0;wallZ=-20;wallHit=false;wallPhase='approaching';
    scene=new THREE.Scene();scene.background=new THREE.Color(0x4a2a0a);
    scene.fog=new THREE.Fog(0x4a2a0a,20,60);
    camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,4,6);camera.lookAt(0,1,-5);
    scene.add(new THREE.AmbientLight(0xaa8844,0.6));
    const sun=new THREE.DirectionalLight(0xffaa44,0.8);sun.position.set(5,10,5);scene.add(sun);
    // torches instead of sun
    const t1=new THREE.PointLight(0xff6622,1.5,15);t1.position.set(-5,3,0);scene.add(t1);
    const t2=new THREE.PointLight(0xff6622,1.5,15);t2.position.set(5,3,0);scene.add(t2);
    // road - temple path
    for(let z=10;z>=-40;z-=2){
      const g=voxBox(16,0.3,2,z%4===0?0x3a2a0a:0x2a1a00);g.position.set(0,-0.15,z);scene.add(g);
      const r=voxBox(5,0.35,2,0x8B4513);r.position.set(0,0,z);scene.add(r);
      if(z%4===0){const m=voxBox(0.8,0.36,0.15,0xFFD700);m.position.set(0,0,z);scene.add(m);}
    }
    // lantern poles along path
    trees3d=[];
    for(let i=0;i<16;i++){
      const side=i%2===0?-1:1;
      const g=new THREE.Group();
      const pole=voxBox(0.2,3,0.2,0x8B4513);pole.position.y=1.5;g.add(pole);
      const lamp=voxBox(0.5,0.5,0.5,0xEE334E);lamp.position.y=3.2;g.add(lamp);
      const glow=new THREE.PointLight(0xff6622,0.4,6);glow.position.y=3.2;g.add(glow);
      g.position.set(side*(4+Math.random()),0,8-i*3);
      scene.add(g);trees3d.push(g);
    }
    // temple gate at end
    const gate=new THREE.Group();
    gate.add(voxBox(0.5,4,0.5,0xEE334E));gate.children[0].position.set(-3,2,-30);
    gate.add(voxBox(0.5,4,0.5,0xEE334E));gate.children[1].position.set(3,2,-30);
    gate.add(voxBox(7,0.5,0.5,0xEE334E));gate.children[2].position.set(0,4,-30);
    gate.add(voxBox(7.5,0.3,0.3,0x8B4513));gate.children[3].position.set(0,4.3,-30);
    scene.add(gate);
    // runner - in traditional colors
    runner3d=makeVoxelChar(0xEE334E,0xFFDDB0);
    runner3d.position.set(0,0.5,0);runner3d.scale.setScalar(0.8);scene.add(runner3d);
    walls3d=[];
    setupQ();
  }
  function setupQ(){
    if(cur>=qs.length||hp<=0){phase='done';return;}
    const q=qs[cur];
    enc.push(...q.idiom.split(''));
    // build 4 wall options: 1 correct meaning + 3 wrong
    let opts=[{label:q.meaning,correct:true}];
    const wrongM=IDIOMS.filter(x=>x.idiom!==q.idiom).map(x=>x.meaning);
    const pool=[...wrongM,...extraMeanings];
    while(opts.length<4){
      const r=pool[Math.floor(Math.random()*pool.length)];
      if(!opts.find(o=>o.label===r))opts.push({label:r,correct:false});
    }
    curOpts=shuffle(opts);
    // create 4 walls
    walls3d.forEach(w=>scene.remove(w.group));walls3d=[];
    const positions=[-2.2,-0.75,0.75,2.2];
    curOpts.forEach((o,i)=>{
      const grp=new THREE.Group();
      const wall=voxBox(1.3,2.5,0.4,0x888888);wall.position.y=1.25;grp.add(wall);
      // scroll banner on wall
      const banner=voxBox(1.1,1.8,0.1,0xf5e6c8);banner.position.set(0,1.5,0.25);grp.add(banner);
      grp.position.set(positions[i],0,-20);
      grp.userData={correct:o.correct,idx:i,broken:false};
      scene.add(grp);walls3d.push({group:grp,correct:o.correct,broken:false});
    });
    wallZ=-20;wallHit=false;wallPhase='approaching';
    if(phase!=='countdown')phase='run';
    updateUI();
  }
  function updateUI(){
    const pct=cur/qs.length;
    let h='';
    h+=g3dProgress(pct*100,'#FFD700');
    let hearts='';for(let i=0;i<3;i++)hearts+=`<span style="font-size:1.2rem;${i>=hp?'filter:grayscale(1) opacity(.3);':''}">${i<hp?'❤️':'🖤'}</span>`;
    h+=g3dHUD(g3dBackBtn()+`<span style="display:flex;gap:2px;margin-left:8px;">${hearts}</span>`,
      `<span style="padding:4px 14px;border-radius:12px;font-size:.8rem;font-weight:800;background:${spdCols[speedLv]};color:#fff;">${spdNames[speedLv]}</span>`,
      g3dBadge(score+'점','rgba(0,0,0,.5)'));
    if(cur<qs.length&&phase==='run'){
      const q=qs[cur];
      h+=`<div style="text-align:center;margin-top:4px;pointer-events:none;">
        <div style="font-size:.7rem;color:rgba(255,255,255,.5);">이 사자성어의 뜻은?</div>
        <div style="font-size:2rem;font-weight:900;color:#FFD700;text-shadow:0 2px 8px rgba(0,0,0,.3);letter-spacing:6px;">${q.idiom}</div>
        <div style="font-size:.75rem;color:rgba(255,255,255,.5);">${q.reading}</div></div>`;
      h+=`<div style="position:absolute;bottom:12px;left:0;right:0;display:flex;flex-direction:column;gap:6px;padding:0 12px;pointer-events:auto;">`;
      curOpts.forEach((o,i)=>{
        h+=`<button class="g3d-btn g3d-ans" data-idx="${i}" onclick="window._idiomAnswer(${i})"
          style="padding:12px 8px;border-radius:14px;font-size:.85rem;font-weight:700;
          background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);color:#fff;
          cursor:pointer;backdrop-filter:blur(8px);text-shadow:0 1px 3px rgba(0,0,0,.4);
          font-family:inherit;text-align:center;">${o.label}</button>`;
      });
      h+=`</div>`;
    }
    if(hp===1)h+=`<div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;box-shadow:inset 0 0 80px 30px rgba(238,51,78,.4);z-index:-1;"></div>`;
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._idiomAnswer=function(idx){
    if(phase!=='run'||wallHit)return;
    wallHit=true;
    const o=curOpts[idx];
    const correctIdx=curOpts.findIndex(x=>x.correct);
    markAnswer(idx,correctIdx);
    const targetWall=walls3d[idx];
    if(o.correct){
      score++;streak++;speedLv=Math.min(3,Math.floor(streak/2));
      SoundSystem.playSound('correct');
      setTimeout(()=>{
        if(targetWall){targetWall.broken=true;GE3D.burst3d(scene,targetWall.group.position.x,1.5,targetWall.group.position.z,0xFFD700,15,4,0.6);targetWall.group.visible=false;}
        GE3D.shake(1,0.2);SoundSystem.playSound('impact_light');
      },200);
    }else{
      wrong.push(qs[cur].idiom);streak=0;speedLv=0;hp--;
      SoundSystem.playSound('wrong');SoundSystem.playSound('impact_heavy');
      setTimeout(()=>{GE3D.shake(3,0.5);GE3D.burst3d(scene,runner3d.position.x,1,runner3d.position.z-1,0xEE334E,20,3,0.6);
        walls3d.forEach((w,i)=>{if(i===correctIdx)w.group.children[0].material=new THREE.MeshLambertMaterial({color:0x00ff00,emissive:0x00ff00,emissiveIntensity:0.3});});
      },200);
      if(hp<=0){setTimeout(()=>{phase='done';updateUI();},800);return;}
    }
    setTimeout(()=>{cur++;setupQ();},800);
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='run';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(phase!=='run')return;
      const spd=1+speedLv*0.5;
      runFrame+=dt*6*(1+speedLv);
      if(runner3d){
        runner3d.position.y=0.5+Math.abs(Math.sin(runFrame))*0.2;
        const legs=runner3d.children.filter((c,i)=>i>=4);
        legs.forEach((l,i)=>{l.rotation.x=Math.sin(runFrame*2+i*Math.PI)*0.6;});
        const arms=runner3d.children.filter((c,i)=>i===2||i===3);
        arms.forEach((a,i)=>{a.rotation.x=Math.sin(runFrame*2+i*Math.PI+Math.PI/2)*0.5;});
      }
      if(!wallHit){wallZ+=dt*3*spd;walls3d.forEach(w=>{w.group.position.z=wallZ;});}
      trees3d.forEach(t=>{t.position.z+=dt*5*spd;if(t.position.z>10)t.position.z-=48;});
      camera.position.y=4+Math.sin(performance.now()/800)*0.05;
      if(hp===1){heartbeatT+=dt;if(heartbeatT>=0.8){heartbeatT=0;SoundSystem.playSound('heartbeat');}}
    },
    onTap(){},
    getResult(){
      recordEncountered(enc);
      const pct=Math.round(score/qs.length*100);const m=getMedalForScore('idiom',pct);
      recordGameResult('idiom',pct,100,m,wrong);
      return{gameId:'idiom',name:'사자성어',score:pct,total:100,medal:m,detail:score+'/'+qs.length+' ('+pct+'%)'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// HOMONYM - SWIMMING VARIANT (동음이의 수영)
// ============================
function createHomonymGame3D(){
  let scene,camera,score,wrong,enc,timeLeft,curQ,answered,phase,countdown,cdT;
  let swimmers3d,buoys3d,waterPlane;
  // Build homonym questions: characters that share same eum reading
  const eumMap={};
  ALL_HANJA.forEach(h=>{if(!eumMap[h.eum])eumMap[h.eum]=[];eumMap[h.eum].push(h);});
  const homSets=Object.entries(eumMap).filter(([k,v])=>v.length>=2).map(([eum,chars])=>({eum,chars}));
  function reset(){
    const qPool=shuffle(homSets).slice(0,20);
    // For each set, create a question: show chars with same reading, ask hun of one
    const questions=[];
    qPool.forEach(s=>{
      const target=s.chars[Math.floor(Math.random()*s.chars.length)];
      let opts=[target.hun];
      while(opts.length<4){const r=ALL_HANJA[Math.floor(Math.random()*ALL_HANJA.length)];if(!opts.includes(r.hun)&&r.eum!==s.eum)opts.push(r.hun);}
      opts=shuffle(opts);
      questions.push({eum:s.eum,chars:s.chars,target,opts,correctIdx:opts.indexOf(target.hun)});
    });
    curQ=questions;score=0;wrong=[];enc=[];answered=false;timeLeft=60;
    phase='countdown';countdown=3;cdT=0;
    scene=new THREE.Scene();scene.background=new THREE.Color(0x0a2a4a);
    scene.fog=new THREE.Fog(0x0a2a4a,25,50);
    camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,8,12);camera.lookAt(0,1,0);
    scene.add(new THREE.AmbientLight(0x4488cc,0.6));
    const dL=new THREE.DirectionalLight(0xeef8ff,0.8);dL.position.set(3,10,5);scene.add(dL);
    const neon1=new THREE.PointLight(0x00ffff,1.2,15);neon1.position.set(-5,4,0);scene.add(neon1);
    const neon2=new THREE.PointLight(0xff00ff,1.2,15);neon2.position.set(5,4,0);scene.add(neon2);
    // pool walls
    const poolLen=30;
    const wallL=voxBox(0.5,1.5,poolLen,0x0081C8);wallL.position.set(-5,0.25,-poolLen/2+5);scene.add(wallL);
    const wallR=voxBox(0.5,1.5,poolLen,0x0081C8);wallR.position.set(5,0.25,-poolLen/2+5);scene.add(wallR);
    const wallF=voxBox(10.5,1.5,0.5,0x0081C8);wallF.position.set(0,0.25,5.25);scene.add(wallF);
    const wallB=voxBox(10.5,1.5,0.5,0x0081C8);wallB.position.set(0,0.25,-poolLen+5.25);scene.add(wallB);
    // water
    const wGeo=new THREE.PlaneGeometry(10,poolLen,20,40);
    const wMat=new THREE.MeshPhongMaterial({color:0x0066cc,transparent:true,opacity:0.7,shininess:80,side:THREE.DoubleSide});
    waterPlane=new THREE.Mesh(wGeo,wMat);waterPlane.rotation.x=-Math.PI/2;waterPlane.position.set(0,0.3,-poolLen/2+5);scene.add(waterPlane);
    // lane buoys
    buoys3d=[];
    for(let lane=-3;lane<=3;lane+=2){
      for(let z=4;z>=-20;z-=3){
        const b=voxBox(0.2,0.2,0.2,z%6===0?0xEE334E:0xFFFFFF);
        b.position.set(lane,0.5,z);scene.add(b);buoys3d.push(b);
      }
    }
    // swimmers (3 voxel swimmers)
    swimmers3d=[];
    [-2,0,2].forEach((x,i)=>{
      const s=makeVoxelChar([0x0081C8,0x00A651,0xEE334E][i],0xFFDDB0);
      s.rotation.x=-Math.PI/4;s.position.set(x,0.3,3);s.scale.setScalar(0.5);
      scene.add(s);swimmers3d.push({mesh:s,progress:0,speed:0.3+Math.random()*0.3,baseX:x});
    });
    // scoreboard
    const board=voxBox(6,2,0.3,0x1a1a2e);board.position.set(0,3.5,5.5);scene.add(board);
    showQuestion(0);
  }
  let qIdx=0;
  function showQuestion(i){
    if(i>=curQ.length||timeLeft<=0){phase='done';return;}
    qIdx=i;answered=false;
    const q=curQ[i];
    q.chars.forEach(c=>enc.push(c.hanja));
    updateUI();
  }
  function updateUI(){
    if(qIdx>=curQ.length){phase='done';return;}
    const q=curQ[qIdx];
    let h='';
    h+=g3dProgress(qIdx/curQ.length*100,'#00ffff');
    h+=g3dHUD(g3dBackBtn(),g3dBadge(Math.ceil(timeLeft)+'s',timeLeft<=10?'rgba(238,51,78,.6)':'rgba(0,0,0,.5)'),
      g3dBadge(score+'문제','rgba(0,255,255,.3)'));
    // show chars with same reading
    h+=`<div style="text-align:center;margin-top:6px;pointer-events:none;">
      <div style="font-size:.7rem;color:rgba(255,255,255,.5);">같은 음 "${q.eum}" - ${q.target.hanja}의 뜻(훈)은?</div>
      <div style="display:flex;justify-content:center;gap:12px;margin-top:4px;">`;
    q.chars.forEach(c=>{
      const isTarget=c.hanja===q.target.hanja;
      h+=`<span style="font-size:${isTarget?'2.5rem':'1.8rem'};font-weight:900;color:${isTarget?'#00ffff':'rgba(255,255,255,.5)'};
        text-shadow:${isTarget?'0 0 15px rgba(0,255,255,.5)':'none'};${isTarget?'border-bottom:3px solid #00ffff;padding-bottom:4px;':''}">${c.hanja}</span>`;
    });
    h+=`</div></div>`;
    // answer buttons
    h+=`<div style="position:absolute;bottom:0;left:0;right:0;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;pointer-events:auto;">`;
    q.opts.forEach((o,i)=>{
      h+=`<button class="g3d-btn g3d-ans" data-idx="${i}" onclick="window._homonymAnswer(${i})"
        style="padding:18px 10px;border-radius:16px;font-size:1.1rem;font-weight:800;
        border:2px solid rgba(255,255,255,.2);color:#fff;text-align:center;
        background:rgba(255,255,255,.12);backdrop-filter:blur(8px);min-height:56px;
        cursor:pointer;transition:all .15s;text-shadow:0 1px 3px rgba(0,0,0,.4);
        font-family:inherit;">${o}</button>`;
    });
    h+=`</div>`;
    if(phase==='countdown')h+=g3dCountdown(countdown);
    GE3D.setUI(h);
  }
  window._homonymAnswer=function(idx){
    if(phase!=='play'||answered)return;
    answered=true;
    const q=curQ[qIdx];
    const correct=idx===q.correctIdx;
    markAnswer(idx,q.correctIdx);
    if(correct){
      score++;SoundSystem.playSound('correct');
      GE3D.shake(1,0.2);
      GE3D.burst3d(scene,0,2,0,0x00ffff,15,3,0.6);
      // advance swimmer
      swimmers3d.forEach(s=>{s.progress+=0.5;});
    }else{
      wrong.push(q.target.hanja+'('+q.target.hun+')');
      SoundSystem.playSound('wrong');GE3D.shake(2,0.3);
      GE3D.burst3d(scene,0,2,0,0xEE334E,10,2,0.4);
    }
    setTimeout(()=>{showQuestion(qIdx+1);},800);
  };
  return{
    scene:null,camera:null,
    init(){reset();this.scene=scene;this.camera=camera;},
    update(dt){
      if(phase==='countdown'){cdT+=dt;if(cdT>=1){countdown--;cdT=0;SoundSystem.playSound('countdown_tick');if(countdown<=0){phase='play';SoundSystem.playSound('countdown_go');}updateUI();}}
      if(phase==='play'){timeLeft-=dt;if(timeLeft<=0){timeLeft=0;phase='done';}
        if(Math.floor(timeLeft)!==Math.floor(timeLeft+dt))updateUI();
      }
      // water animation
      if(waterPlane){
        const geo=waterPlane.geometry;const pos=geo.attributes.position;
        const t=performance.now()/1000;
        for(let i=0;i<pos.count;i++){
          const x=pos.getX(i),y=pos.getY(i);
          pos.setZ(i,Math.sin(x*2+t*3)*0.08+Math.cos(y*1.5+t*2)*0.05);
        }
        pos.needsUpdate=true;
      }
      // swimmers animation
      swimmers3d.forEach((s,i)=>{
        const targetZ=3-s.progress*2;
        s.mesh.position.z+=(targetZ-s.mesh.position.z)*dt*2;
        s.mesh.position.y=0.3+Math.sin(performance.now()/300+i)*0.1;
        // arm stroke
        const arms=s.mesh.children.filter((c,j)=>j===2||j===3);
        arms.forEach((a,j)=>{a.rotation.x=Math.sin(performance.now()/200+j*Math.PI)*0.8;});
      });
      // buoys bob
      buoys3d.forEach((b,i)=>{b.position.y=0.5+Math.sin(performance.now()/500+i*0.5)*0.1;});
    },
    onTap(){},
    getResult(){
      recordEncountered(enc);
      const place=score>=15?1:score>=10?2:score>=5?3:4;
      const m=getMedalForScore('homonym',score);
      recordGameResult('homonym',score,0,m,wrong);
      return{gameId:'homonym',name:'동음이의',score,total:0,medal:m,detail:'60초 '+score+'문제 정답 ('+place+'위)'};
    },
    cleanup(){if(scene){while(scene.children.length>0)scene.remove(scene.children[0]);}},
    isDone(){return phase==='done';}
  };
}

// ============================
// START GAME (Three.js)
// ============================
function startGame(gameId){
  const signal=Router.navigate('screen-'+gameId);
  SoundSystem.init();
  if(!GE3D.renderer)GE3D.init();
  let game;
  switch(gameId){
    case 'archery':game=createArcheryGame3D();break;
    case 'swimming':game=createSwimmingGame3D();break;
    case 'weightlifting':game=createWeightliftingGame3D();break;
    case 'gymnastics':game=createGymnasticsGame3D();break;
    case 'marathon':game=createMarathonGame3D();break;
    case 'antonym':game=createAntonymGame3D();break;
    case 'idiom':game=createIdiomGame3D();break;
    case 'homonym':game=createHomonymGame3D();break;
  }
  if(!game)return;
  game.init();
  const checkDone=setInterval(()=>{
    if(game.isDone()){
      clearInterval(checkDone);GE3D.stop();
      const r=game.getResult();showResult(r.gameId,r.name,r.score,r.total,r.medal,r.detail);
    }
  },100);
  signal.addEventListener('abort',()=>{clearInterval(checkDone);GE3D.stop();});
  GE3D.start(game);
}

function startDaily(){
  const signal=Router.navigate('screen-daily');
  const container=$('screen-daily');
  container.innerHTML='';
  const engine=createDailyEngine();
  currentEngine=engine;
  engine.init(container,signal);
  engine.start();
}

// ============================
// RESULT SCREEN
// ============================
function showResult(gameId,gameName,score,total,medal,detail){
  const signal=Router.navigate('screen-result');
  const content=$('result-content');
  const medalText=medal==='gold'?'금메달':medal==='silver'?'은메달':medal==='bronze'?'동메달':'';
  const emoji=medal?medalEmoji(medal):'😊';
  if(medal)setTimeout(()=>{SoundSystem.playSound('medal');spawnConfetti();},300);
  content.innerHTML=`
    <div style="display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;">
      <div class="result-medal">${emoji}</div>
      <div class="result-title">${gameName} ${medal?'':'도전'} 결과</div>
      ${medal?`<div style="font-size:1.2rem;font-weight:700;color:${medal==='gold'?'var(--gold)':medal==='silver'?'var(--silver)':'var(--bronze)'}">${medalText} 획득!</div>`:''}
      <div class="result-score">${gameId==='gymnastics'?score+'회':gameId==='marathon'?score+'%':score+'점'}</div>
      <div class="result-detail">${detail}</div>
      <div class="result-buttons">
        <button class="btn-primary full-width" id="res-retry">다시 도전</button>
        <button class="btn-secondary full-width" id="res-hub">종목 선택</button>
        <button class="btn-outline full-width" id="res-lb">리더보드</button>
      </div>
    </div>
  `;
  $('res-retry').addEventListener('click',()=>{
    if(gameId==='daily')startDaily();else startGame(gameId);
  },{signal});
  $('res-hub').addEventListener('click',()=>showHub(),{signal});
  $('res-lb').addEventListener('click',()=>showLeaderboard(),{signal});
}

// ============================
// LEADERBOARD
// ============================
function showLeaderboard(){
  const signal=Router.navigate('screen-leaderboard');
  const tabs=['종합','양궁','수영','역도','체조','마라톤'];
  const tabIds=['total','archery','swimming','weightlifting','gymnastics','marathon'];
  let activeTab='total';
  const tabsEl=$('lb-tabs');
  tabsEl.innerHTML=tabs.map((t,i)=>`<button class="lb-tab ${i===0?'active':''}" data-tab="${tabIds[i]}">${t}</button>`).join('');
  tabsEl.querySelectorAll('.lb-tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      activeTab=btn.dataset.tab;
      tabsEl.querySelectorAll('.lb-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderLB(activeTab);
    },{signal});
  });
  $('lb-back').addEventListener('click',()=>showHub(),{signal});
  renderLB('total');
}

function renderLB(tab){
  const list=$('lb-list');
  const users=Store.getAllUsers();
  const snapshot=Store.getRankSnapshot();
  const currentUser=Store.getCurrentUser();
  let ranked=[];
  if(tab==='total'){
    ranked=Object.entries(users).map(([name,u])=>({
      name,icon:u.icon,
      points:(u.medals.gold||0)*3+(u.medals.silver||0)*2+(u.medals.bronze||0),
      detail:`🥇${u.medals.gold||0} 🥈${u.medals.silver||0} 🥉${u.medals.bronze||0}`
    })).sort((a,b)=>b.points-a.points);
  }else{
    ranked=Object.entries(users).filter(([,u])=>u.bestScores&&u.bestScores[tab]).map(([name,u])=>{
      const b=u.bestScores[tab];
      return{name,icon:u.icon,
        points:tab==='gymnastics'?1000-b.score:b.score,
        detail:tab==='gymnastics'?`${b.score}회`:tab==='marathon'?`${b.score}%`:`${b.score}점`,
        medal:b.medal
      };
    }).sort((a,b)=>b.points-a.points);
  }
  if(ranked.length===0){
    list.innerHTML='<div style="text-align:center;padding:40px;color:#888;">아직 기록이 없습니다</div>';
    return;
  }
  list.innerHTML=ranked.map((r,i)=>{
    const rank=i+1;
    const oldRank=snapshot[r.name];
    let changeHtml='';
    if(!oldRank)changeHtml='<span class="lb-change new">NEW</span>';
    else if(oldRank>rank)changeHtml=`<span class="lb-change up">&#9650;${oldRank-rank}</span>`;
    else if(oldRank<rank)changeHtml=`<span class="lb-change down">&#9660;${rank-oldRank}</span>`;
    else changeHtml='<span class="lb-change same">&mdash;</span>';
    const isMe=r.name===currentUser;
    return`<div class="lb-item ${isMe?'lb-me':''} anim-fadeIn" style="animation-delay:${i*0.05}s">
      <span class="lb-rank ${rank===1?'gold':rank===2?'silver':rank===3?'bronze':''}">${rank<=3?['🥇','🥈','🥉'][rank-1]:rank}</span>
      <span class="lb-icon">${r.icon}</span>
      <div class="lb-info"><div class="lb-name">${r.name}</div><div class="lb-score">${r.detail}</div></div>
      ${tab==='total'?changeHtml:''}
    </div>`;
  }).join('');
}

// ============================
// PROFILE
// ============================
function showProfile(){
  const signal=Router.navigate('screen-profile');
  $('profile-back').addEventListener('click',()=>showHub(),{signal});
  const username=Store.getCurrentUser();
  const user=Store.getUser(username);
  if(!user){showAuth();return;}
  const content=$('profile-content');
  const medals=user.medals||{gold:0,silver:0,bronze:0};
  const encountered=user.encounteredCharacters||[];
  const wrong=user.wrongAnswers||{};
  const history=user.history||[];
  const dc=user.dailyChallenge||{};

  // top 3 wrong
  const wrongSorted=Object.entries(wrong).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const wrongHtml=wrongSorted.map(([hanja,count])=>{
    const h=ALL_HANJA.find(x=>x.hanja===hanja);
    if(!h)return'';
    return`<div class="profile-wrong-item">
      <span class="profile-wrong-hanja">${h.hanja}</span>
      <span class="profile-wrong-info">${h.fullHunEum}</span>
      <span class="profile-wrong-count">${count}회 틀림</span>
    </div>`;
  }).join('');

  // recent history
  const histHtml=history.slice(0,10).map(h=>{
    const g=GAME_LIST.find(x=>x.id===h.gameId)||(h.gameId==='daily'?{name:'일일 도전',icon:'📅'}:null);
    if(!g)return'';
    const d=new Date(h.date);
    const dateStr=`${d.getMonth()+1}/${d.getDate()}`;
    return`<div class="profile-game-row">
      <span>${g.icon} ${g.name}</span>
      <span>${h.medal?medalEmoji(h.medal):''} ${h.score}${h.gameId==='gymnastics'?'회':h.gameId==='marathon'?'%':'점'}</span>
      <span style="font-size:.8rem;color:#aaa">${dateStr}</span>
    </div>`;
  }).join('');

  // best scores
  const bestHtml=[...GAME_LIST,{id:'daily',name:'일일 도전',icon:'📅'}].map(g=>{
    const b=user.bestScores&&user.bestScores[g.id];
    return`<div class="profile-game-row">
      <span>${g.icon} ${g.name}</span>
      <span>${b?`${b.medal?medalEmoji(b.medal):''} ${b.score}${g.id==='gymnastics'?'회':g.id==='marathon'?'%':'점'}`:'미도전'}</span>
    </div>`;
  }).join('');

  const progressPct=Math.round(encountered.length/ALL_HANJA.length*100);

  content.innerHTML=`
    <div class="profile-header">
      <div class="profile-icon">${user.icon}</div>
      <div class="profile-name">${username}</div>
    </div>
    <div class="profile-medals">
      <div class="profile-medal-item"><div class="profile-medal-icon">🥇</div><div class="profile-medal-count">${medals.gold}</div><div class="profile-medal-label">금메달</div></div>
      <div class="profile-medal-item"><div class="profile-medal-icon">🥈</div><div class="profile-medal-count">${medals.silver}</div><div class="profile-medal-label">은메달</div></div>
      <div class="profile-medal-item"><div class="profile-medal-icon">🥉</div><div class="profile-medal-count">${medals.bronze}</div><div class="profile-medal-label">동메달</div></div>
    </div>
    ${dc.streak?`<div style="text-align:center;color:var(--blue);font-weight:600;margin-bottom:8px;">일일 도전 연속 ${dc.streak}일</div>`:''}
    <div class="profile-section">
      <div class="profile-section-title">학습 진도</div>
      <div style="font-size:.85rem;color:#666;margin-bottom:4px;">${encountered.length}/${ALL_HANJA.length}자 학습 (${progressPct}%)</div>
      <div class="profile-progress-bar"><div class="profile-progress-fill" style="width:${progressPct}%"></div></div>
    </div>
    <div class="profile-section" style="margin-top:16px;">
      <div class="profile-section-title">종목별 최고 기록</div>
      ${bestHtml}
    </div>
    ${wrongSorted.length>0?`<div class="profile-section" style="margin-top:16px;">
      <div class="profile-section-title">오답노트 (자주 틀린 한자)</div>
      ${wrongHtml}
    </div>`:''}
    ${histHtml?`<div class="profile-section" style="margin-top:16px;">
      <div class="profile-section-title">최근 기록</div>
      ${histHtml}
    </div>`:''}
    <button class="btn-red full-width" style="margin-top:20px;" id="profile-logout">로그아웃</button>
  `;
  $('profile-logout').addEventListener('click',()=>{
    Store.logout();showAuth();
  },{signal});
}

// ============================
// STUDY MODE
// ============================
function showStudy(){
  const signal=Router.navigate('screen-study');
  $('study-back').addEventListener('click',()=>showHub(),{signal});
  const content=$('study-content');
  const username=Store.getCurrentUser();
  const user=Store.getUser(username);
  const wrong=user&&user.wrongAnswers?user.wrongAnswers:{};

  const categories=['전체','오답노트',...Object.keys(HANJA_BY_CATEGORY)];
  let activeFilter='전체';
  let filteredList=[...ALL_HANJA];
  let cardIndex=0;
  let isFlipped=false;

  function getFiltered(){
    if(activeFilter==='전체')return ALL_HANJA;
    if(activeFilter==='오답노트'){
      const wrongChars=Object.keys(wrong);
      return ALL_HANJA.filter(h=>wrongChars.includes(h.hanja));
    }
    return HANJA_BY_CATEGORY[activeFilter]||[];
  }

  function render(){
    filteredList=getFiltered();
    if(cardIndex>=filteredList.length)cardIndex=0;
    const h=filteredList[cardIndex];
    const hasCards=filteredList.length>0;

    content.innerHTML=`
      <div class="study-filters" id="study-filters">
        ${categories.map(c=>`<button class="study-filter ${c===activeFilter?'active':''}" data-cat="${c}">${c}${c==='오답노트'?` (${Object.keys(wrong).length})`:(HANJA_BY_CATEGORY[c]?` (${HANJA_BY_CATEGORY[c].length})`:c==='전체'?` (${ALL_HANJA.length})`:'')} </button>`).join('')}
      </div>
      ${hasCards?`
        <div class="study-card-container" id="study-card-tap">
          <div class="study-card" id="study-card">
            <div class="study-card-face study-front">
              <div class="study-category">${h.category}</div>
              <div class="study-hanja">${h.hanja}</div>
              <div style="font-size:.85rem;color:#aaa;margin-top:8px;">탭하여 뒤집기</div>
            </div>
            <div class="study-card-face study-back">
              <div class="study-category">${h.category}</div>
              <div class="study-hanja">${h.hanja}</div>
              <div class="study-huneum">${h.fullHunEum}</div>
              <div style="font-size:.9rem;color:#666;">훈: ${h.hun} / 음: ${h.eum}</div>
            </div>
          </div>
        </div>
        <div class="study-nav">
          <button class="btn-secondary" id="study-prev" style="font-size:1.3rem;">&#8592;</button>
          <span class="study-counter">${cardIndex+1} / ${filteredList.length}</span>
          <button class="btn-secondary" id="study-next" style="font-size:1.3rem;">&#8594;</button>
        </div>
      `:'<div style="text-align:center;padding:40px;color:#888;">해당 한자가 없습니다</div>'}

      <div class="study-section">
        <div class="study-section-title">사자성어</div>
        ${IDIOMS.map(id=>`<div class="idiom-card">
          <div class="idiom-hanja">${id.idiom}</div>
          <div class="idiom-reading">${id.reading}</div>
          <div class="idiom-meaning">${id.meaning}</div>
        </div>`).join('')}
      </div>

      <div class="study-section">
        <div class="study-section-title">반의어 짝</div>
        <div class="antonym-grid">
          ${ANTONYM_PAIRS.map(([a,b])=>{
            const ha=ALL_HANJA.find(x=>x.hanja===a);
            const hb=ALL_HANJA.find(x=>x.hanja===b);
            return`<div class="antonym-pair">
              <div class="antonym-hanja">${a} ↔ ${b}</div>
              <div class="antonym-reading">${ha?ha.fullHunEum:''} / ${hb?hb.fullHunEum:''}</div>
            </div>`;
          }).join('')}
        </div>
      </div>
    `;
    isFlipped=false;
    // bind events
    content.querySelectorAll('.study-filter').forEach(btn=>{
      btn.addEventListener('click',()=>{
        activeFilter=btn.dataset.cat;cardIndex=0;render();
      },{signal});
    });
    if(hasCards){
      $('study-card-tap').addEventListener('click',()=>{
        isFlipped=!isFlipped;
        $('study-card').classList.toggle('flipped',isFlipped);
        SoundSystem.playSound('flip');
      },{signal});
      $('study-prev').addEventListener('click',()=>{
        cardIndex=(cardIndex-1+filteredList.length)%filteredList.length;render();
      },{signal});
      $('study-next').addEventListener('click',()=>{
        cardIndex=(cardIndex+1)%filteredList.length;render();
      },{signal});
    }
  }
  render();
}

// ============================
// INIT
// ============================
initSplash();
</script>
</body>
</html>
